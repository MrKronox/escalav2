<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador Pro - IASD</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --iasd-blue: #003366; --iasd-gold: #c5a059; --bg: #f0f2f5; --success: #22c55e; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; color: #333; }
        header { background: var(--iasd-blue); color: white; padding: 20px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { padding: 15px; max-width: 600px; margin: auto; }
        
        .card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .card h3 { margin-top: 0; color: var(--iasd-blue); font-size: 1.1rem; display: flex; align-items: center; gap: 10px; }
        
        /* Estilo dos Seletores de Vagas */
        .config-row { display: flex; align-items: center; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #f0f0f0; }
        .config-row:last-child { border-bottom: none; }
        .day-info { display: flex; flex-direction: column; }
        .day-name { font-weight: bold; color: #444; }
        .day-sub { font-size: 0.75rem; color: #888; }
        
        .counter { display: flex; align-items: center; gap: 12px; background: #f8f9fa; padding: 5px 10px; border-radius: 20px; }
        .counter button { background: white; border: 1px solid #ddd; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        .counter span { font-weight: bold; min-width: 20px; text-align: center; }

        .btn-magic { width: 100%; padding: 16px; background: var(--iasd-blue); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 1rem; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 12px rgba(0,51,102,0.2); }
        .btn-magic:active { transform: scale(0.98); }

        .resumo-vagas { background: #eef2f7; padding: 10px; border-radius: 8px; font-size: 0.85rem; margin-top: 10px; color: var(--iasd-blue); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; font-size: 0.75rem; color: #888; text-transform: uppercase; padding: 8px; }
        td { padding: 12px 8px; border-top: 1px solid #f0f0f0; }
        .badge-date { background: var(--iasd-blue); color: white; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; font-weight: bold; }
        
        .membro-tag { background: #e8f5e9; color: #2e7d32; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem; margin-right: 4px; display: inline-block; border: 1px solid #c8e6c9; }
    </style>
</head>
<body>

<header id="headerDinamico">Gerador de Escala</header>

<div class="container">
    <div class="card">
        <h3>üìÖ Per√≠odo da Escala</h3>
        <div style="display: flex; gap: 10px;">
            <div style="flex: 2;">
                <label style="font-size: 0.8rem; color: #666;">M√™s</label>
                <select id="mesEscala" onchange="atualizarTextoVagas()"></select>
            </div>
            <div style="flex: 1;">
                <label style="font-size: 0.8rem; color: #666;">Ano</label>
                <input type="number" id="anoEscala" readonly style="background: #f0f0f0; border: none; font-weight: bold;">
            </div>
        </div>
    </div>

    <div class="card">
        <h3>üë• Vagas por Culto</h3>
        <div id="configVagas">
            </div>
        <div class="resumo-vagas" id="resumoVagas">Selecione o m√™s para calcular</div>
    </div>

    <button class="btn-magic" onclick="executarSorteioInteligente()">‚ú® Gerar Escala Justa</button>

    <div id="areaResultado" class="card" style="display:none; margin-top: 20px;">
        <h3>üìã Resultado da Equipe</h3>
        <div id="tabelaResultado"></div>
        <button class="btn-magic" style="background: var(--success); margin-top: 15px;">üíæ Publicar Escala</button>
    </div>
</div>



<script>
    // 1. Configura√ß√£o e Vari√°veis Globais
    const urlParams = new URLSearchParams(window.location.search);
    const deptoLogado = urlParams.get('depto') || "Som";
    const firebaseConfig = { /* ... seu config ... */ };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const mesesNomes = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
    const vagasPorDia = { 0: 2, 3: 1, 6: 2 }; // Padr√£o: Dom(2), Qua(1), Sab(2)

    // 2. Inicializa√ß√£o
    window.onload = () => {
        document.getElementById('headerDinamico').innerText = `üöÄ Gerador: ${deptoLogado}`;
        
        const dataAtual = new Date();
        const inputAno = document.getElementById('anoEscala');
        const selectMes = document.getElementById('mesEscala');
        
        inputAno.value = dataAtual.getFullYear();
        
        mesesNomes.forEach((mes, i) => {
            let opt = document.createElement('option');
            opt.value = i;
            opt.text = mes;
            if(i === dataAtual.getMonth() + 1) opt.selected = true; // Sugere o pr√≥ximo m√™s
            selectMes.appendChild(opt);
        });

        renderizarConfigVagas();
        atualizarTextoVagas();
    };

    function renderizarConfigVagas() {
        const container = document.getElementById('configVagas');
        const dias = [
            { id: 6, nome: "S√°bado", sub: "Culto Divino / Jovem" },
            { id: 0, nome: "Domingo", sub: "Culto Evangel√≠stico" },
            { id: 3, nome: "Quarta-feira", sub: "Culto de Ora√ß√£o" }
        ];

        container.innerHTML = dias.map(d => `
            <div class="config-row">
                <div class="day-info">
                    <span class="day-name">${d.nome}</span>
                    <span class="day-sub">${d.sub}</span>
                </div>
                <div class="counter">
                    <button onclick="alterarVaga(${d.id}, -1)">-</button>
                    <span id="vaga-val-${d.id}">${vagasPorDia[d.id]}</span>
                    <button onclick="alterarVaga(${d.id}, 1)">+</button>
                </div>
            </div>
        `).join('');
    }

    function alterarVaga(id, delta) {
        vagasPorDia[id] = Math.max(0, vagasPorDia[id] + delta);
        document.getElementById(`vaga-val-${id}`).innerText = vagasPorDia[id];
        atualizarTextoVagas();
    }

    function atualizarTextoVagas() {
        const mes = document.getElementById('mesEscala').value;
        const ano = document.getElementById('anoEscala').value;
        // L√≥gica para contar quantos s√°bados, domingos e quartas tem no m√™s...
        document.getElementById('resumoVagas').innerText = `Configurado para ${deptoLogado} em ${mesesNomes[mes]}`;
    }

    async function executarSorteioInteligente() {
        const mes = parseInt(document.getElementById('mesEscala').value);
        const ano = parseInt(document.getElementById('anoEscala').value);

        // 1. Puxar membros
        const snapshot = await db.ref('equipes_deptos').orderByChild('departamento').equalTo(deptoLogado).once('value');
        let membros = [];
        snapshot.forEach(child => { membros.push(child.val()); });

        if(membros.length === 0) return alert("Adicione membros primeiro!");

        // 2. Criar Calend√°rio do M√™s
        let diasNoMes = [];
        let data = new Date(ano, mes, 1);
        while(data.getMonth() === mes) {
            const ds = data.getDay();
            if(vagasPorDia[ds] > 0) {
                diasNoMes.push({
                    dataStr: data.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'}),
                    diaSemana: ds,
                    vagas: vagasPorDia[ds],
                    escalados: []
                });
            }
            data.setDate(data.getDate() + 1);
        }

        // 3. SORTEIO COM L√ìGICA DE FILA (ROUND-ROBIN)
        // Embaralha a lista inicial para ser justo
        membros.sort(() => Math.random() - 0.5);
        
        let pointer = 0;
        diasNoMes.forEach(dia => {
            let disponiveis = membros.filter(m => m.disponibilidade.includes(dia.diaSemana.toString()));
            
            for(let v=0; v < dia.vagas; v++) {
                if(disponiveis.length > 0) {
                    // Pega o pr√≥ximo da fila que esteja dispon√≠vel
                    let escolhido = disponiveis[pointer % disponiveis.length];
                    dia.escalados.push(escolhido.nomeExibicao);
                    pointer++;
                }
            }
        });

        renderizarResultado(diasNoMes);
    }

    function renderizarResultado(dias) {
        let html = `<table><thead><tr><th>DATA</th><th>VOLUNT√ÅRIOS</th></tr></thead><tbody>`;
        dias.forEach(d => {
            const tags = d.escalados.map(n => `<span class="membro-tag">${n}</span>`).join('');
            html += `<tr>
                <td><span class="badge-date">${d.dataStr}</span></td>
                <td>${tags || '<span style="color:#ccc">---</span>'}</td>
            </tr>`;
        });
        html += `</tbody></table>`;
        document.getElementById('tabelaResultado').innerHTML = html;
        document.getElementById('areaResultado').style.display = 'block';
    }
</script>
</body>
</html>