<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Escalas - IASD</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    
    <link rel="manifest" href="manifest.json">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icone-app.png">

    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('Service Worker registrado com sucesso!'))
            .catch(err => console.error('Falha ao registrar Service Worker:', err));
        });
    }
    </script>
    
    
    
    
    
    <style>
        :root { 
            --iasd-blue: #003366; 
            --iasd-gold: #c5a059; 
            --iasd-light-blue: #f4f7fa;
            --text-dark: #2d3748;
            --border: #e2e8f0;
        }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: #f0f2f5; 
            margin: 0; 
            color: var(--text-dark);
        }

        header { 
            background: #003366; 
            color: white; 
            padding: 25px 15px; 
            text-align: center;
            border-bottom: 5px solid #c5a059; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        header h1 { margin: 0; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; }
        header p { margin: 5px 0 0; font-size: 0.7rem; letter-spacing: 3px; opacity: 0.9; }

        .container { padding: 20px; max-width: 900px; margin: auto; }

        .card { 
            background: white; 
            border-radius: 8px; 
            padding: 24px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            margin-bottom: 25px; 
            border: 1px solid var(--border);
        }

        #cardResultado {
            overflow-x: auto;
        }

        .section-header { 
            display: flex; 
            align-items: center; 
            margin-bottom: 25px; 
            padding-left: 12px;
            border-left: 4px solid var(--iasd-blue);
        }
        
        .section-header h3 { 
            margin: 0; 
            color: var(--iasd-blue); 
            font-size: 0.9rem; 
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .grid-inputs { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
        }

        .input-group label { 
            display: block; 
            font-size: 0.75rem; 
            font-weight: 700; 
            color: #718096; 
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .input-group input { 
            width: 100%; 
            padding: 12px; 
            border: 1.5px solid var(--border); 
            border-radius: 6px; 
            box-sizing: border-box;
        }
        /* Container da grade mais fluido e moderno */
        .frequencia-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); 
            gap: 15px; 
            margin-top: 10px;
        }

        /* O "Bubble" do Dia - Estilo de App Premium */
        .dia-bubble { 
            background: white;
            border: 2px solid #edf2f7;
            border-radius: 20px; /* Bordas bem arredondadas */
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        /* Estado Ativo: Eleva√ß√£o e Cor */
        .dia-bubble.active { 
            border-color: var(--iasd-blue);
            background-color: #f8faff;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 51, 102, 0.1);
        }

        .dia-bubble .dia-nome { 
            display: block; 
            font-weight: 800; 
            font-size: 0.8rem;
            color: #94a3b8; 
            margin-bottom: 10px; 
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .dia-bubble.active .dia-nome { color: var(--iasd-blue); }

        /* Seletor Num√©rico flutuante */
        .pessoas-control { 
            background: #f1f5f9;
            border-radius: 12px;
            padding: 6px 10px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s ease;
        }

        .dia-bubble.active .pessoas-control {
            background: var(--iasd-blue);
            color: white;
        }

        .pessoas-control input { 
            width: 30px; 
            background: transparent;
            border: none;
            text-align: center;
            font-weight: bold;
            color: inherit;
            font-size: 1rem;
            outline: none;
        }

        /* Remove setas padr√£o do input num√©rico */
        .pessoas-control input::-webkit-inner-spin-button,
        .pessoas-control input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .label-unidade {
            font-size: 0.6rem;
            font-weight: 700;
            opacity: 0.6;
            text-transform: uppercase;
        }

        .dia-card.active { 
            border-color: var(--iasd-blue);
            background-color: var(--iasd-light-blue);
        }

        .dia-card .nome { display: block; font-weight: 800; color: var(--text-dark); margin-bottom: 5px; }
        .dia-card.active .nome { color: var(--iasd-blue); }
        .dia-card .label-pess { font-size: 0.65rem; color: #a0aec0; display: block; margin-bottom: 5px; }

        .dia-card input { 
            width: 50px; 
            padding: 5px; 
            border: 1px solid var(--border); 
            border-radius: 4px; 
            text-align: center; 
            font-weight: bold;
        }

        .btn-iasd { 
            background: var(--iasd-blue); 
            color: white; 
            border: none; 
            width: 100%; 
            padding: 18px; 
            border-radius: 8px; 
            font-weight: bold; 
            text-transform: uppercase; 
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 51, 102, 0.2);
        }

        .badge-membro {
            background: var(--iasd-blue);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
        }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; border-bottom: 2px solid var(--iasd-gold); padding: 10px; }
        td { padding: 10px; border-bottom: 1px solid var(--border); }


        /* Bal√£o Estilizado (Pop-up) */
        .menu-contexto {
            display: none; /* Escondido por padr√£o */
            position: absolute;
            z-index: 1000;
            width: 160px;
            background-color: #242832;
            background-image: linear-gradient(139deg, #242832 0%, #251c28 100%);
            border-radius: 8px;
            padding: 8px 0;
            box-shadow: 0 10px 15px rgba(0,0,0,0.3);
        }

        .menu-contexto ul { list-style: none; margin: 0; padding: 0; }

        .menu-contexto li {
            padding: 8px 12px;
            color: #7e8590;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: 0.2s;
        }

        .menu-contexto li:hover { background: #5353ff; color: #fff; }
        .menu-contexto li.delete:hover { background: #8e2a2a; }

        /* Indicador de Aten√ß√£o */
        .alerta-conflito {
            width: 8px;
            height: 8px;
            background: #e53e3e;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            animation: pulse 1.5s infinite;
        }

        .nome-container {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .nome-container:hover { background: rgba(0, 51, 102, 0.05); }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        @media (max-width: 600px) {
            .grid-inputs { grid-template-columns: 1fr; }
        }
        /* Bot√£o Voltar Estilizado */
        .btn-voltar-container {
            margin-bottom: 20px;
            display: inline-block;
        }

        .button-back {
            background-color: transparent;
            color: var(--iasd-blue);
            width: 8.5em;
            height: 2.9em;
            border: var(--iasd-blue) 0.15em solid; /* Borda um pouco mais fina para eleg√¢ncia */
            border-radius: 11px;
            text-align: right;
            transition: all 0.5s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            cursor: pointer;
            font-weight: 600;
            padding: 0;
        }

        .button-back:hover {
            background-color: var(--iasd-blue);
            color: #fff;
        }

        .button-back svg {
            width: 1.4em;
            left: 0.8em;
            position: absolute;
            transition: all 0.5s ease;
            /* Invertendo a seta para apontar para a esquerda */
            transform: rotate(180deg); 
        }

        .button-back:hover svg {
            transform: rotate(180deg) translateX(5px);
            stroke: #fff;
        }

        .button-back .text {
            margin: 0 1.2em;
        }

        /* Estiliza√ß√£o do aviso de conflito dentro do bal√£o escuro */
        .conflito-info {
            background: rgba(255, 255, 255, 0.1); /* Fundo levemente claro para destacar do preto */
            border-bottom: 1px solid rgba(255, 77, 77, 0.3);
            padding: 12px;
            margin-bottom: 5px;
            border-radius: 8px 8px 0 0;
            color: #ff8080; /* Vermelho claro/salm√£o para leitura no fundo escuro */
            font-size: 0.75rem;
            line-height: 1.4;
            text-align: center;
            font-weight: 600;
        }

        .conflito-info strong {
            color: #ff4d4d; /* Vermelho mais vivo para o "ATEN√á√ÉO" */
            display: block;
            margin-bottom: 4px;
            text-transform: uppercase;
            font-size: 0.65rem;
            letter-spacing: 1px;
        }
        /* Container que ser√° transformado em imagem download da escala(fica fora da tela) */
        #escala-export {
            position: absolute;
            left: -9999px; /* Mant√©m fora da visualiza√ß√£o do usu√°rio */
            width: 600px;
            padding: 40px;
            background-color: white; /* Cor de seguran√ßa */
            background-size: cover;
            background-position: center;
            border-radius: 10px;
            font-family: sans-serif;
        }

        /* Camada de transpar√™ncia para destacar o texto */
        .overlay-export {
            background: rgba(255, 255, 255, 0.85); 
            padding: 20px;
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        #escala-export h2 {
            color: var(--iasd-blue);
            text-align: center;
            text-transform: uppercase;
            border-bottom: 2px solid var(--iasd-gold);
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        #escala-export table {
            width: 100%;
            border-collapse: collapse;
        }

        #escala-export th, #escala-export td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #cbd5e0;
        }
    </style>
</head>
<body>

<header>
    <p>IGREJA ADVENTISTA DO S√âTIMO DIA</p>
    <h1 id="headerTitle">SISTEMA DE GEST√ÉO DE ESCALAS</h1>
</header>

<div class="container">
   <div class="btn-voltar-container" style="margin-bottom: 20px;">
        <button class="button-back" onclick="voltarParaMembros()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12h15m0 0l-6.75-6.75M19.5 12l-6.75 6.75" />
            </svg>
            <div class="text">Voltar</div>
        </button>
    </div>
    <div class="btn-voltar-container">
        <button class="button-back" onclick="window.location.href='index.html'" style="width: 8em;">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="transform: rotate(0deg);">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
            </svg>
            <span class="text">Home</span>
        </button>
    </div>

    
    <div class="card">
        <div class="section-header"><h3>üìñ Per√≠odo e Departamento</h3></div>
        <div class="grid-inputs">
            <div class="input-group">
                <label>Departamento Selecionado</label>
                <div id="displayDepto" style="font-weight: bold; color: var(--iasd-blue); padding: 12px; background: var(--iasd-light-blue); border-radius: 6px; border: 1.5px solid var(--border);">Carregando...</div>
            </div>
            <div class="input-group">
                <label>M√™s de Refer√™ncia</label>
                <input type="month" id="mesRef" onchange="atualizarDatasAutomaticas()">
            </div>
            <div class="input-group">
                <label>Data In√≠cio</label>
                <input type="date" id="dataInicio">
            </div>
            <div class="input-group">
                <label>Data Fim</label>
                <input type="date" id="dataFim">
            </div>
        </div>
    </div>

    <div class="card">
        <div class="section-header"><h3>‚öôÔ∏è Frequ√™ncia (Dias e Pessoas)</h3></div>
        <div class="frequencia-grid">
            <div class="dia-bubble active" onclick="toggleDia(this, 0)" data-dia="0">
                <span class="dia-nome">Dom</span>
                <div class="pessoas-control" onclick="event.stopPropagation()">
                    <input type="number" value="1" min="1">
                    <span class="label-unidade">Pessoa</span>
                </div>
            </div>

            <div class="dia-bubble" onclick="toggleDia(this, 1)" data-dia="1">
                <span class="dia-nome">Seg</span>
                <div class="pessoas-control" onclick="event.stopPropagation()">
                    <input type="number" value="1" min="1">
                    <span class="label-unidade">Pessoa</span>
                </div>
            </div>

            <div class="dia-bubble" onclick="toggleDia(this, 2)" data-dia="2">
                <span class="dia-nome">Ter</span>
                <div class="pessoas-control" onclick="event.stopPropagation()">
                    <input type="number" value="1" min="1">
                    <span class="label-unidade">Pessoa</span>
                </div>
            </div>

            <div class="dia-bubble active" onclick="toggleDia(this, 3)" data-dia="3">
                <span class="dia-nome">Qua</span>
                <div class="pessoas-control" onclick="event.stopPropagation()">
                    <input type="number" value="1" min="1">
                    <span class="label-unidade">Pessoa</span>
                </div>
            </div>

            <div class="dia-bubble" onclick="toggleDia(this, 4)" data-dia="4">
                <span class="dia-nome">Qui</span>
                <div class="pessoas-control" onclick="event.stopPropagation()">
                    <input type="number" value="1" min="1">
                    <span class="label-unidade">Pessoa</span>
                </div>
            </div>

            <div class="dia-bubble" onclick="toggleDia(this, 5)" data-dia="5">
                <span class="dia-nome">Sex</span>
                <div class="pessoas-control" onclick="event.stopPropagation()">
                    <input type="number" value="1" min="1">
                    <span class="label-unidade">Pessoa</span>
                </div>
            </div>

            <div class="dia-bubble active" onclick="toggleDia(this, 6)" data-dia="6">
                <span class="dia-nome">S√°b</span>
                <div class="pessoas-control" onclick="event.stopPropagation()">
                    <input type="number" value="1" min="1">
                    <span class="label-unidade">Pessoa</span>
                </div>
            </div>
        </div>
    </div>

    <button class="btn-iasd" onclick="gerarEscala()">Gerar Escala</button>

    <div class="card" id="cardResultado" style="margin-top: 20px; display: none;">
        <div class="section-header"><h3>üìÖ Escala Gerada</h3></div>
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Dia</th>
                    <th>Respons√°veis</th>
                </tr>
            </thead>
            <tbody id="resultadoEscala"></tbody>
        </table>

        <div style="margin-top: 20px; text-align: center;">
        <button onclick="salvarEscalaNoFirebase()" class="btn-iasd" style="background-color: #28a745;">
            üíæ Salvar Escala Oficial
        </button>
    </div>

    </div>
</div>

<script>
    const imagensDeptos = {
        "Escola Sabatina": "sabatina.png",
        "Recep√ß√£o": "recepcao.jpg",
        "Prega√ß√£o": "pregacao.jpg",
        "T√©cnico de Som": "mesa-som.png",
        "Louvor Especial": "louvor.png",
        "Louvor Congregacional": "louvor.png",
        "Limpeza": "limpeza.jpeg",
        "Infantil": "infantil.jpg",
        "Di√°conos": "diacono.jpg"
    };

    let listaMembrosOficiais = []; 
    
    const firebaseConfig = {
        apiKey: "AIzaSyBYtUnqsokLE1RnK1TGbswbnsLXPpvvdc0",
        authDomain: "escala7igreja.firebaseapp.com",
        databaseURL: "https://escala7igreja-default-rtdb.firebaseio.com",
        projectId: "escala7igreja",
        storageBucket: "escala7igreja.firebasestorage.app",
        messagingSenderId: "778312493987",
        appId: "1:778312493987:web:2851b2fc65331e4ac14816"
    };

    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    const urlParams = new URLSearchParams(window.location.search);
    const deptoLogado = urlParams.get('depto') || "Geral";
    let deptoLogadoLimpo = deptoLogado.replace(/\./g, "").trim();
    let diasAtivos = [0, 3, 6];

    // --- INICIALIZA√á√ÉO ---
    window.onload = () => {
        document.getElementById('displayDepto').innerText = deptoLogado;
        if(document.getElementById('nomeDeptoBotao')) {
            document.getElementById('nomeDeptoBotao').innerText = deptoLogado;
        }
        
        const d = new Date();
        const ano = d.getFullYear();
        const mes = String(d.getMonth() + 1).padStart(2, '0');
        
        document.getElementById('mesRef').value = `${ano}-${mes}`;
        atualizarDatasAutomaticas();
        carregarEscalaSalva(); // Carrega o que j√° existe no banco
    };

    // --- FUN√á√ïES DE APOIO ---
    function toggleDia(card, diaIndex) {
        card.classList.toggle('active');
        const dia = parseInt(diaIndex);
        if (card.classList.contains('active')) {
            if (!diasAtivos.includes(dia)) diasAtivos.push(dia);
        } else {
            diasAtivos = diasAtivos.filter(d => d !== dia);
        }
    }

    function atualizarDatasAutomaticas() {
        const mesRef = document.getElementById('mesRef').value;
        if(mesRef) {
            const [ano, mes] = mesRef.split('-');
            const primeiro = new Date(ano, mes - 1, 1);
            const ultimo = new Date(ano, mes, 0);
            const formatar = (data) => {
                const z = data.getTimezoneOffset() * 60 * 1000;
                const local = new Date(data - z);
                return local.toISOString().split('T')[0];
            };
            document.getElementById('dataInicio').value = formatar(primeiro);
            document.getElementById('dataFim').value = formatar(ultimo);
        }
    }

    // --- L√ìGICA DE GERA√á√ÉO ---
    async function gerarEscala() {
        const dataInicioVal = document.getElementById('dataInicio').value;
        const dataFimVal = document.getElementById('dataFim').value;
        
        if (!dataInicioVal || !dataFimVal) return alert("Selecione o per√≠odo da escala.");

        const dataInicio = new Date(dataInicioVal + 'T00:00:00');
        const dataFim = new Date(dataFimVal + 'T00:00:00');

        try {
            const mesRef = document.getElementById('mesRef').value;
            if (!mesRef) return alert("Selecione o m√™s de refer√™ncia.");

            // 1. BUSCA DE DADOS NO FIREBASE
            const snapshotTodasEscalas = await db.ref("escalas_salvas").once("value");
            const todasEscalasDoMes = snapshotTodasEscalas.val() || {};

            const snapshotMembros = await db.ref("equipes_deptos").once("value");
            let voluntarios = [];
            listaMembrosOficiais = []; 
            
            snapshotMembros.forEach(child => {
                const dados = child.val();
                if (dados.departamento === deptoLogado) {
                    const nomeFinal = dados.nomeExibicao || dados.nomeCompleto || "Sem Nome";
                    voluntarios.push({
                        id: child.key,
                        nome: nomeFinal, 
                        vezesEscaladoNoMes: 0, // Contador para equil√≠brio mensal
                        disponibilidade: dados.disponibilidade || [] 
                    });
                    if(!listaMembrosOficiais.includes(nomeFinal)) listaMembrosOficiais.push(nomeFinal);
                }
            });

            if (voluntarios.length === 0) return alert("Nenhum membro encontrado para este departamento.");

            // 2. CONFIGURA√á√ïES INICIAIS DO SORTEIO
            let corpoTabela = "";
            let dataAtual = new Date(dataInicio);
            let ultimoSorteadoId = null;
            const diasNome = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"];

            // 3. LOOP PRINCIPAL POR DATA
            while (dataAtual <= dataFim) {
                const diaSemana = dataAtual.getDay();
                const dataParaBusca = dataAtual.toLocaleDateString('pt-BR'); 
                const dataParaExibicao = `${String(dataAtual.getDate()).padStart(2, '0')}/${String(dataAtual.getMonth() + 1).padStart(2, '0')}`;

                if (diasAtivos.includes(diaSemana)) {
                    const bubbleDia = document.querySelector(`.dia-bubble[data-dia="${diaSemana}"]`);
                    const qtdPessoas = parseInt(bubbleDia ? bubbleDia.querySelector('input').value : 1) || 1;
                    let escaladosNoDiaLocal = [];

                    for (let i = 0; i < qtdPessoas; i++) {
                        // FILTRO 1: Disponibilidade e n√£o estar repetido na mesma linha
                        let aptos = voluntarios.filter(v => {
                            const disp = Array.isArray(v.disponibilidade) ? v.disponibilidade : Object.values(v.disponibilidade);
                            return disp.map(Number).includes(diaSemana) && !escaladosNoDiaLocal.includes(v.id);
                        });

                        if (aptos.length > 0) {
                            // --- L√ìGICA DE JUSTI√áA E PESO (O CORA√á√ÉO DO SISTEMA) ---
                            let candidatosRankeados = aptos.map(v => {
                                let conflitosNoDia = [];
                                // Verifica se j√° est√° em outros departamentos hoje
                                Object.keys(todasEscalasDoMes).forEach(depto => {
                                    if (depto !== deptoLogado && todasEscalasDoMes[depto][mesRef]) {
                                        const jaEscaladoEmOutro = todasEscalasDoMes[depto][mesRef].corpo?.some(item => 
                                            item.data === dataParaBusca && item.nome === v.nome
                                        );
                                        if (jaEscaladoEmOutro) conflitosNoDia.push(depto);
                                    }
                                });

                                // C√ÅLCULO DE PESO: Quanto MENOR o valor, maior a chance.
                                // Conflitos pesam muito (50 pontos), carga mensal pesa moderado (10 pontos).
                                let pesoJustica = (v.vezesEscaladoNoMes * 10) + (conflitosNoDia.length * 50);
                                
                                // Penaliza levemente se foi o √∫ltimo sorteado (evita repeti√ß√£o seguida)
                                if (v.id === ultimoSorteadoId) pesoJustica += 25;

                                return { ...v, peso: pesoJustica, conflitosAtuais: conflitosNoDia };
                            });

                            // Ordena pelo menor peso (mais justo)
                            candidatosRankeados.sort((a, b) => a.peso - b.peso);

                            // Sorteia entre os que empataram no menor peso para manter aleatoriedade
                            const menorPesoEncontrado = candidatosRankeados[0].peso;
                            const finalistas = candidatosRankeados.filter(c => c.peso === menorPesoEncontrado);
                            const sorteado = finalistas[Math.floor(Math.random() * finalistas.length)];

                            // ATUALIZA√á√ÉO DE ESTADO
                            const volRef = voluntarios.find(v => v.id === sorteado.id);
                            volRef.vezesEscaladoNoMes++; // Incrementa carga mensal
                            ultimoSorteadoId = sorteado.id;
                            escaladosNoDiaLocal.push(sorteado.id);

                            const conflitoStr = sorteado.conflitosAtuais.join(', ');
                            const temAlerta = sorteado.conflitosAtuais.length > 0;

                            // 4. CONSTRU√á√ÉO DA LINHA NA TABELA
                            corpoTabela += `
                                <tr>
                                    <td>${i === 0 ? `<strong>${dataParaExibicao}</strong>` : ''}</td>
                                    <td style="color: #718096;">${i === 0 ? diasNome[diaSemana] : ''}</td>
                                    <td>
                                        <div class="nome-container" onclick="toggleMenu(event, this)" 
                                            data-conflitos="${conflitoStr}" data-data-real="${dataParaBusca}">
                                            ${temAlerta ? '<span class="alerta-conflito"></span>' : ''}
                                            <span class="texto-nome" style="font-weight: 600; color: ${temAlerta ? '#e53e3e' : 'var(--iasd-blue)'};">
                                                ${sorteado.nome}
                                            </span>
                                        </div>
                                        <div class="menu-contexto">
                                            <ul>
                                                <li onclick="ativarEdicao(this)"><span>‚úé</span> Editar</li>
                                                <li class="delete" onclick="excluirLinha(this)"><span>üóë</span> Excluir</li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>`;
                        }
                    }
                }
                dataAtual.setDate(dataAtual.getDate() + 1);
            }

            document.getElementById('resultadoEscala').innerHTML = corpoTabela;
            document.getElementById('cardResultado').style.display = 'block';
            
            // Opcional: Revalida visualmente os conflitos ap√≥s gerar
            if (typeof revalidarTodosOsConflitos === "function") revalidarTodosOsConflitos();

        } catch (e) { 
            console.error("Falha na gera√ß√£o:", e); 
            alert("Erro t√©cnico ao gerar escala: " + e.message);
        }
    }

    function voltarParaMembros() {
        window.location.href = `membros.html?depto=${encodeURIComponent(deptoLogado)}`;
    }


    // --- SALVAMENTO E PERSIST√äNCIA ---
    async function salvarEscalaNoFirebase() {
        const mesRef = document.getElementById('mesRef').value;
        if (!mesRef) return alert("Selecione o m√™s de refer√™ncia.");

        const linhas = document.querySelectorAll('#resultadoEscala tr');
        let dadosParaSalvar = [];

        linhas.forEach(linha => {
            const container = linha.querySelector('.nome-container');
            const textoNomeElement = linha.querySelector('.texto-nome');
            
            if (container && textoNomeElement) {
                const dataDataReal = container.getAttribute('data-data-real');
                const nomeTexto = textoNomeElement.innerText.trim();
                const diaTexto = linha.cells[1] ? linha.cells[1].innerText : "";

                if (dataDataReal && nomeTexto && nomeTexto !== "---") {
                    dadosParaSalvar.push({ 
                        data: dataDataReal,
                        diaSemana: diaTexto, 
                        nome: nomeTexto
                    });
                }
            }
        });

        if (dadosParaSalvar.length === 0) return alert("N√£o h√° nomes v√°lidos para salvar.");

        // "E. Sabatina" vira "E Sabatina"
        const deptoParaSalvar = deptoLogado.replace(/\./g, "").trim(); 

        try {
            const escalaData = {
                ultimaAtualizacao: new Date().toISOString(),
                corpo: dadosParaSalvar
            };

            console.log("Tentando salvar em:", `escalas_salvas/${deptoParaSalvar}/${mesRef}`);

            // Usamos await para esperar a resposta do servidor do Firebase
            await db.ref("escalas_salvas/" + deptoParaSalvar + "/" + mesRef).set(escalaData);
            
            // Se chegou aqui, o Firebase confirmou o recebimento
            console.log("‚úÖ Firebase confirmou a grava√ß√£o!");
            alert("‚úÖ Escala salva com sucesso no banco de dados!");
            
            try {
                await baixarEscalaComoImagem();
            } catch (errImg) {
                console.error("Erro na imagem:", errImg);
            }
            
            if (typeof revalidarTodosOsConflitos === "function") {
                await revalidarTodosOsConflitos();
            }
            
        } catch (error) { 
            console.error("Erro real no Firebase:", error);
            alert("Erro t√©cnico ao salvar: " + error.message); 
        }
    }

    // Fun√ß√£o que varre a tabela ap√≥s salvar para manter os alertas visuais ativos
    async function revalidarTodosOsConflitos() {
        const containers = document.querySelectorAll('.nome-container');
        for (let container of containers) {
            const nome = container.querySelector('.texto-nome').innerText;
            const dataReal = container.getAttribute('data-data-real');
            const conflitos = await verificarNovoConflito(nome, dataReal);
            
            const temAlerta = conflitos.length > 0;
            container.setAttribute('data-conflitos', conflitos.join(', '));
            
            // Atualiza o visual sem precisar regerar a tabela toda
            const spanNome = container.querySelector('.texto-nome');
            spanNome.style.color = temAlerta ? '#e53e3e' : 'var(--iasd-blue)';
            
            // Adiciona ou remove a bolinha vermelha
            let bolinha = container.querySelector('.alerta-conflito');
            if (temAlerta && !bolinha) {
                container.insertAdjacentHTML('afterbegin', '<span class="alerta-conflito"></span>');
            } else if (!temAlerta && bolinha) {
                bolinha.remove();
            }
        }
    }

    async function carregarEscalaSalva() {
        const mesRef = document.getElementById('mesRef').value;
        try {
            const snapshot = await db.ref("escalas_salvas").child(deptoLogado).child(mesRef).once("value");
            const dados = snapshot.val();

            if (dados && dados.corpo) {
                let corpoTabela = "";
                // Como carregarEscalaSalva roda ao iniciar, precisamos buscar conflitos atuais
                const snapGeral = await db.ref("escalas_salvas").once("value");
                const todas = snapGeral.val() || {};

                dados.corpo.forEach((item, index) => {
                    const mostrarData = (index === 0 || dados.corpo[index-1].data !== item.data);
                    
                    // Verifica conflito em tempo real no carregamento
                    let conflitos = [];
                    Object.keys(todas).forEach(d => {
                        if (d !== deptoLogado && todas[d][mesRef]) {
                            if (todas[d][mesRef].corpo.some(i => i.data === item.data && i.nome === item.nome)) conflitos.push(d);
                        }
                    });

                    const temAlerta = conflitos.length > 0;
                    corpoTabela += `
                        <tr>
                            <td>${mostrarData ? `<strong>${item.data.split('/')[0]}/${item.data.split('/')[1]}</strong>` : ''}</td>
                            <td style="color: #718096;">${mostrarData ? item.diaSemana : ''}</td>
                            <td>
                                <div class="nome-container" onclick="toggleMenu(event, this)" 
                                     data-conflitos="${conflitos.join(', ')}" data-data-real="${item.data}">
                                    ${temAlerta ? '<span class="alerta-conflito"></span>' : ''}
                                    <span class="texto-nome" style="font-weight: 600; color: ${temAlerta ? '#e53e3e' : 'var(--iasd-blue)'};">${item.nome}</span>
                                </div>
                                <div class="menu-contexto">
                                    <ul>
                                        <li onclick="ativarEdicao(this)"><span>‚úé</span> Editar</li>
                                        <li class="delete" onclick="excluirLinha(this)"><span>üóë</span> Excluir</li>
                                    </ul>
                                </div>
                            </td>
                        </tr>`;
                });
                document.getElementById('resultadoEscala').innerHTML = corpoTabela;
                document.getElementById('cardResultado').style.display = 'block';
            }
        } catch (e) { console.error(e); }
    }

    // --- MENU DE CONTEXTO E EDI√á√ÉO ---
    function toggleMenu(event, elemento) {
        event.stopPropagation();
        document.querySelectorAll('.menu-contexto').forEach(m => m.style.display = 'none');
        const menu = elemento.nextElementSibling;
        const conflitos = elemento.getAttribute('data-conflitos');
        
        let areaAviso = menu.querySelector('.conflito-info') || document.createElement('div');
        areaAviso.className = 'conflito-info';
        if (!menu.querySelector('.conflito-info')) menu.prepend(areaAviso);

        if (conflitos) {
            areaAviso.innerHTML = `<strong>‚ö†Ô∏è Conflito</strong><br>Escalado em: ${conflitos}`;
            areaAviso.style.display = 'block';
        } else { areaAviso.style.display = 'none'; }

        menu.style.display = 'block';
        const fechar = () => { menu.style.display = 'none'; document.removeEventListener('click', fechar); };
        document.addEventListener('click', fechar);
    }

    function ativarEdicao(itemMenu) {
        const td = itemMenu.closest('td');
        const container = td.querySelector('.nome-container');
        const nomeAtual = container.querySelector('.texto-nome').innerText;
        td.querySelector('.menu-contexto').style.display = 'none';

        const idLista = "lista_" + Math.floor(Math.random() * 1000);
        const opcoes = listaMembrosOficiais.map(n => `<option value="${n}">`).join('');

        container.innerHTML = `
            <div style="display: flex; gap: 5px; width: 100%;" onclick="event.stopPropagation()">
                <input type="text" list="${idLista}" id="inputEdit" value="${nomeAtual}" 
                    style="padding: 5px; border: 1px solid var(--iasd-gold); border-radius: 4px; width: 120px; font-size: 0.8rem;">
                <datalist id="${idLista}">${opcoes}</datalist>
                <button onclick="confirmarEdicao(this)" style="background: var(--iasd-blue); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.7rem;">OK</button>
            </div>
        `;
        container.onclick = (e) => e.stopPropagation();
    }

    async function confirmarEdicao(botao) {
        const novoNome = botao.parentElement.querySelector('#inputEdit').value;
        const container = botao.closest('.nome-container');
        const dataReal = container.getAttribute('data-data-real');
        
        if (novoNome.trim() !== "") {
            const conflitos = await verificarNovoConflito(novoNome, dataReal);
            const temAlerta = conflitos.length > 0;
            container.setAttribute('data-conflitos', conflitos.join(', '));
            container.innerHTML = `
                ${temAlerta ? '<span class="alerta-conflito"></span>' : ''}
                <span class="texto-nome" style="font-weight: 600; color: ${temAlerta ? '#e53e3e' : 'var(--iasd-blue)'};">${novoNome}</span>
            `;
            setTimeout(() => { container.onclick = (e) => toggleMenu(e, container); }, 100);
        }
    }

    function excluirLinha(itemMenu) {
        if(confirm("Remover este registro?")) {
            itemMenu.closest('tr').remove();
        }
    }

    async function verificarNovoConflito(nome, dataReal) {
        const mesRef = document.getElementById('mesRef').value;
        const snap = await db.ref("escalas_salvas").once("value");
        const todas = snap.val() || {};
        let conflitos = [];

        // Prote√ß√£o para escala nova: Se n√£o houver data de atualiza√ß√£o, usamos o "agora"
        let minhaAtualizacao = Date.now();
        if (todas[deptoLogado] && todas[deptoLogado][mesRef] && todas[deptoLogado][mesRef].ultimaAtualizacao) {
            minhaAtualizacao = new Date(todas[deptoLogado][mesRef].ultimaAtualizacao).getTime();
        }

        Object.keys(todas).forEach(depto => {
            if (depto !== deptoLogado && todas[depto][mesRef]) {
                // Se o outro departamento n√£o tiver data (erro de dado), assumimos que ele √© antigo (0)
                const dataOutra = todas[depto][mesRef].ultimaAtualizacao;
                const outraAtualizacao = dataOutra ? new Date(dataOutra).getTime() : 0;

                // S√≥ gera alerta se o outro departamento salvou ANTES de voc√™
                if (outraAtualizacao < minhaAtualizacao) { 
                    const jaEscalado = todas[depto][mesRef].corpo?.some(i => i.data === dataReal && i.nome === nome);
                    if (jaEscalado) conflitos.push(depto);
                }
            }
        });
        return conflitos;
    }

    async function baixarEscalaComoImagem() {
        const mesRef = document.getElementById('mesRef').value;
        const corpoOriginal = document.getElementById('resultadoEscala').innerHTML;
        
        // Define a imagem baseada no departamento logado
        const nomeImagem = imagensDeptos[deptoLogado] || "sabatina.png"; // sabatina como padr√£o
        const caminhoImagem = `IMG/${nomeImagem}`;

        const exportArea = document.createElement('div');
        exportArea.id = 'escala-export';
        
        // Aplica a imagem de fundo diretamente no estilo
        exportArea.style.backgroundImage = `url('${caminhoImagem}')`;

        exportArea.innerHTML = `
            <div class="overlay-export">
                <h2 style="text-align:center; color: #1a365d; margin-bottom: 5px;">ESCALA: ${deptoLogado.toUpperCase()}</h2>
                <p style="text-align:center; color: #718096; margin-bottom: 20px;">M√™s de Refer√™ncia: ${mesRef}</p>
                <table style="width:100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: #1a365d; color: white;">
                            <th style="padding: 10px; text-align: left;">Data</th>
                            <th style="padding: 10px; text-align: left;">Dia</th>
                            <th style="padding: 10px; text-align: left;">Escalado</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${corpoOriginal}
                    </tbody>
                </table>
                <div style="margin-top: 30px; text-align: center; border-top: 1px solid #ddd; padding-top: 10px;">
                    <p style="font-size: 12px; color: #4a5568;">"Servi ao Senhor com alegria" - Salmos 100:2</p>
                </div>
            </div>
        `;
        
        document.body.appendChild(exportArea);

        // Pequeno delay para garantir que a imagem de fundo seja lida antes do "print"
        setTimeout(() => {
            html2canvas(exportArea, {
                scale: 2,
                useCORS: true, // Importante para carregar imagens locais/externas
                allowTaint: true
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Escala_${deptoLogado}_${mesRef}.png`;
                link.href = canvas.toDataURL("image/png");
                link.click();
                document.body.removeChild(exportArea);
            });
        }, 500); 
    }


</script>
</body>
</html>
