<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Escalas - IASD</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { 
            --iasd-blue: #003366; 
            --iasd-gold: #c5a059; 
            --iasd-light-blue: #f4f7fa;
            --text-dark: #2d3748;
            --border: #e2e8f0;
        }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: #f0f2f5; 
            margin: 0; 
            color: var(--text-dark);
        }

        header { 
            background: #003366; 
            color: white; 
            padding: 25px 15px; 
            text-align: center;
            border-bottom: 5px solid #c5a059; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        header h1 { margin: 0; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; }
        header p { margin: 5px 0 0; font-size: 0.7rem; letter-spacing: 3px; opacity: 0.9; }

        .container { padding: 20px; max-width: 900px; margin: auto; }

        .card { 
            background: white; 
            border-radius: 8px; 
            padding: 24px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            margin-bottom: 25px; 
            border: 1px solid var(--border);
        }

        .section-header { 
            display: flex; 
            align-items: center; 
            margin-bottom: 25px; 
            padding-left: 12px;
            border-left: 4px solid var(--iasd-blue);
        }
        
        .section-header h3 { 
            margin: 0; 
            color: var(--iasd-blue); 
            font-size: 0.9rem; 
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .grid-inputs { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
        }

        .input-group label { 
            display: block; 
            font-size: 0.75rem; 
            font-weight: 700; 
            color: #718096; 
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .input-group input { 
            width: 100%; 
            padding: 12px; 
            border: 1.5px solid var(--border); 
            border-radius: 6px; 
            box-sizing: border-box;
        }

        .frequencia-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); 
            gap: 12px; 
        }

        .dia-card { 
            background: white;
            border: 2px solid var(--border);
            border-radius: 10px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .dia-card.active { 
            border-color: var(--iasd-blue);
            background-color: var(--iasd-light-blue);
        }

        .dia-card .nome { display: block; font-weight: 800; color: var(--text-dark); margin-bottom: 5px; }
        .dia-card.active .nome { color: var(--iasd-blue); }
        .dia-card .label-pess { font-size: 0.65rem; color: #a0aec0; display: block; margin-bottom: 5px; }

        .dia-card input { 
            width: 50px; 
            padding: 5px; 
            border: 1px solid var(--border); 
            border-radius: 4px; 
            text-align: center; 
            font-weight: bold;
        }

        .btn-iasd { 
            background: var(--iasd-blue); 
            color: white; 
            border: none; 
            width: 100%; 
            padding: 18px; 
            border-radius: 8px; 
            font-weight: bold; 
            text-transform: uppercase; 
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 51, 102, 0.2);
        }

        .badge-membro {
            background: var(--iasd-blue);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
        }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; border-bottom: 2px solid var(--iasd-gold); padding: 10px; }
        td { padding: 10px; border-bottom: 1px solid var(--border); }

        @media (max-width: 600px) {
            .grid-inputs { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<header>
    <p>IGREJA ADVENTISTA DO S√âTIMO DIA</p>
    <h1 id="headerTitle">SISTEMA DE GEST√ÉO DE ESCALAS</h1>
</header>

<div class="container">
    <div style="margin-bottom: 15px;">
        <a href="javascript:void(0)" onclick="voltarParaMembros()" style="text-decoration: none; color: var(--iasd-blue); font-weight: bold;">
            ‚Üê Voltar para Gest√£o de Membros
        </a>
    </div>
    
    <div class="card">
        <div class="section-header"><h3>üìñ Per√≠odo e Departamento</h3></div>
        <div class="grid-inputs">
            <div class="input-group">
                <label>Departamento Selecionado</label>
                <div id="displayDepto" style="font-weight: bold; color: var(--iasd-blue); padding: 12px; background: var(--iasd-light-blue); border-radius: 6px; border: 1.5px solid var(--border);">Carregando...</div>
            </div>
            <div class="input-group">
                <label>M√™s de Refer√™ncia</label>
                <input type="month" id="mesRef" onchange="atualizarDatasAutomaticas()">
            </div>
            <div class="input-group">
                <label>Data In√≠cio</label>
                <input type="date" id="dataInicio">
            </div>
            <div class="input-group">
                <label>Data Fim</label>
                <input type="date" id="dataFim">
            </div>
        </div>
    </div>

    <div class="card">
        <div class="section-header"><h3>‚öôÔ∏è Frequ√™ncia (Dias e Pessoas)</h3></div>
        <div class="frequencia-grid">
            <div class="dia-card active" onclick="toggleDia(this, 0)" data-dia="0"><span class="nome">Dom</span><span class="label-pess">Pess.</span><input type="number" value="1" onclick="event.stopPropagation()"></div>
            <div class="dia-card" onclick="toggleDia(this, 1)" data-dia="1"><span class="nome">Seg</span><span class="label-pess">Pess.</span><input type="number" value="1" onclick="event.stopPropagation()"></div>
            <div class="dia-card" onclick="toggleDia(this, 2)" data-dia="2"><span class="nome">Ter</span><span class="label-pess">Pess.</span><input type="number" value="1" onclick="event.stopPropagation()"></div>
            <div class="dia-card active" onclick="toggleDia(this, 3)" data-dia="3"><span class="nome">Qua</span><span class="label-pess">Pess.</span><input type="number" value="1" onclick="event.stopPropagation()"></div>
            <div class="dia-card" onclick="toggleDia(this, 4)" data-dia="4"><span class="nome">Qui</span><span class="label-pess">Pess.</span><input type="number" value="1" onclick="event.stopPropagation()"></div>
            <div class="dia-card" onclick="toggleDia(this, 5)" data-dia="5"><span class="nome">Sex</span><span class="label-pess">Pess.</span><input type="number" value="1" onclick="event.stopPropagation()"></div>
            <div class="dia-card active" onclick="toggleDia(this, 6)" data-dia="6"><span class="nome">S√°b</span><span class="label-pess">Pess.</span><input type="number" value="1" onclick="event.stopPropagation()"></div>
        </div>
    </div>

    <button class="btn-iasd" onclick="gerarEscala()">Gerar Escala Inteligente</button>

    <div class="card" id="cardResultado" style="margin-top: 20px; display: none;">
        <div class="section-header"><h3>üìÖ Escala Gerada</h3></div>
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Dia</th>
                    <th>Respons√°veis</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="resultadoEscala"></tbody>
        </table>
    </div>
</div>

<script>
    let listaMembrosParaAutocomplete = [];
    
    const firebaseConfig = {
        apiKey: "AIzaSyBYtUnqsokLE1RnK1TGbswbnsLXPpvvdc0",
        authDomain: "escala7igreja.firebaseapp.com",
        databaseURL: "https://escala7igreja-default-rtdb.firebaseio.com", // Verifique se esta URL est√° correta no seu console
        projectId: "escala7igreja",
        storageBucket: "escala7igreja.firebasestorage.app",
        messagingSenderId: "778312493987",
        appId: "1:778312493987:web:2851b2fc65331e4ac14816"
    };

    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database(); // VOLTANDO PARA REALTIME

    const urlParams = new URLSearchParams(window.location.search);
    const deptoLogado = urlParams.get('depto') || "Geral";
    let diasAtivos = [0, 3, 6];

    function toggleDia(card, diaIndex) {
        card.classList.toggle('active');
        const dia = parseInt(diaIndex);
        if (card.classList.contains('active')) {
            if (!diasAtivos.includes(dia)) diasAtivos.push(dia);
        } else {
            diasAtivos = diasAtivos.filter(d => d !== dia);
        }
    }

    function atualizarDatasAutomaticas() {
        const mesRef = document.getElementById('mesRef').value;
        if(mesRef) {
            const [ano, mes] = mesRef.split('-');
            const primeiro = new Date(ano, mes - 1, 1);
            const ultimo = new Date(ano, mes, 0);
            const formatar = (data) => {
                const z = data.getTimezoneOffset() * 60 * 1000;
                const local = new Date(data - z);
                return local.toISOString().split('T')[0];
            };
            document.getElementById('dataInicio').value = formatar(primeiro);
            document.getElementById('dataFim').value = formatar(ultimo);
        }
    }

    window.onload = () => {
        document.getElementById('displayDepto').innerText = deptoLogado;
        const d = new Date();
        document.getElementById('mesRef').value = d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, '0');
        atualizarDatasAutomaticas();
    };

    async function gerarEscala() {
        const dataInicioVal = document.getElementById('dataInicio').value;
        const dataFimVal = document.getElementById('dataFim').value;
        const dataInicio = new Date(dataInicioVal + 'T00:00:00');
        const dataFim = new Date(dataFimVal + 'T00:00:00');

        try {
            // 1. Puxa Membros do caminho correto 'equipes_deptos'
            const snapshotMembros = await db.ref("equipes_deptos").once("value");
            let voluntarios = [];
            listaMembrosOficiais = []; // Reinicia a lista para o autocomplete
            
            snapshotMembros.forEach(child => {
                const dados = child.val();
                
                if (dados.departamento === deptoLogado) {
                    const nomeFinal = dados.nomeExibicao || dados.nomeCompleto || "Sem Nome";
                    
                    voluntarios.push({
                        id: child.key,
                        nome: nomeFinal, 
                        vezesEscalado: 0,
                        disponibilidade: dados.disponibilidade || [] 
                    });

                    // Alimenta a lista do autocomplete para o bot√£o l√°pis
                    if(!listaMembrosOficiais.includes(nomeFinal)) {
                        listaMembrosOficiais.push(nomeFinal);
                    }
                }
            });

            if (voluntarios.length === 0) {
                alert("Nenhum membro encontrado para: " + deptoLogado);
                return;
            }

            let corpoTabela = "";
            let dataAtual = new Date(dataInicio);
            let ultimoSorteadoId = null;
            const diasNome = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"];

            while (dataAtual <= dataFim) {
                const diaSemana = dataAtual.getDay();
                
                if (diasAtivos.includes(diaSemana)) {
                    let aptos = voluntarios.filter(v => {
                        const disp = Array.isArray(v.disponibilidade) ? v.disponibilidade : Object.values(v.disponibilidade);
                        return disp.map(Number).includes(diaSemana);
                    });

                    if (aptos.length > 1) {
                        aptos = aptos.filter(v => v.id !== ultimoSorteadoId);
                    }

                    aptos.sort((a, b) => a.vezesEscalado - b.vezesEscalado);

                    if (aptos.length > 0) {
                        const sorteado = aptos[0];
                        sorteado.vezesEscalado++;
                        ultimoSorteadoId = sorteado.id;

                        corpoTabela += `
                            <tr>
                                <td>${dataAtual.toLocaleDateString('pt-BR')}</td>
                                <td style="color: #a0aec0;">${diasNome[diaSemana]}</td>
                                <td style="font-weight: 500; color: var(--iasd-blue);">${sorteado.nome}</td>
                                <td>
                                    <button onclick="editarLinha(this)" style="background:none; border:none; cursor:pointer; color:#f6ad55; font-size:1.2rem; margin-right:10px;">‚úé</button>
                                    <button onclick="excluirLinha(this)" style="background:none; border:none; cursor:pointer; color:#e53e3e; font-size:1.2rem;">üóë</button>
                                </td>
                            </tr>`;
                    }
                }
                dataAtual.setDate(dataAtual.getDate() + 1);
            }
            
            document.getElementById('resultadoEscala').innerHTML = corpoTabela;
            document.getElementById('cardResultado').style.display = 'block';

        } catch (error) {
            console.error("Erro Realtime:", error);
            alert("Erro ao ler dados: " + error.message);
        }
    }

    function voltarParaMembros() {
        window.location.href = `membros.html?depto=${encodeURIComponent(deptoLogado)}`;
    }

    function excluirLinha(botao) {
        if(confirm("Deseja remover este registro da escala?")) {
            botao.closest('tr').remove();
        }
    }

    function editarLinha(botao) {
        const linha = botao.closest('tr');
        const celulaNome = linha.cells[2];
        const nomeAtual = celulaNome.innerText;

        // Criar datalist din√¢mico para o autocomplete
        const idLista = "lista_" + Math.floor(Math.random() * 1000);
        const opcoes = listaMembrosOficiais.map(n => `<option value="${n}">`).join('');

        celulaNome.innerHTML = `
            <div style="display: flex; gap: 5px;">
                <input type="text" list="${idLista}" id="inputEdit" value="${nomeAtual}" 
                    style="padding: 5px; border: 1px solid var(--iasd-gold); border-radius: 4px; width: 100%;">
                <datalist id="${idLista}">${opcoes}</datalist>
                <button onclick="confirmarEdicao(this)" style="background: var(--iasd-blue); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">OK</button>
            </div>
        `;
    }

    function confirmarEdicao(botao) {
        const novoNome = botao.parentElement.querySelector('#inputEdit').value;
        const celula = botao.closest('td');
        if (novoNome.trim() !== "") {
            celula.innerHTML = novoNome;
            celula.style.fontWeight = "500";
            celula.style.color = "var(--iasd-blue)";
        }
    }
</script>
</body>
</html>
