<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Escalas - IASD</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { 
            --iasd-blue: #003366; 
            --iasd-gold: #c5a059; 
            --iasd-light-blue: #f4f7fa;
            --text-dark: #2d3748;
            --border: #e2e8f0;
        }

        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            background: #f0f2f5; 
            margin: 0; 
            color: var(--text-dark);
        }

        header { 
            background: #003366; 
            color: white; 
            padding: 25px 15px; 
            text-align: center;
            border-bottom: 5px solid #c5a059; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        header h1 { margin: 0; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; }
        header p { margin: 5px 0 0; font-size: 0.7rem; letter-spacing: 3px; opacity: 0.9; }

        .container { padding: 20px; max-width: 900px; margin: auto; }

        .card { 
            background: white; 
            border-radius: 8px; 
            padding: 24px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            margin-bottom: 25px; 
            border: 1px solid var(--border);
        }

        #cardResultado {
            overflow-x: auto;
        }

        .section-header { 
            display: flex; 
            align-items: center; 
            margin-bottom: 25px; 
            padding-left: 12px;
            border-left: 4px solid var(--iasd-blue);
        }
        
        .section-header h3 { 
            margin: 0; 
            color: var(--iasd-blue); 
            font-size: 0.9rem; 
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .grid-inputs { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
        }

        .input-group label { 
            display: block; 
            font-size: 0.75rem; 
            font-weight: 700; 
            color: #718096; 
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .input-group input { 
            width: 100%; 
            padding: 12px; 
            border: 1.5px solid var(--border); 
            border-radius: 6px; 
            box-sizing: border-box;
        }
        /* Container da grade mais fluido e moderno */
        .frequencia-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); 
            gap: 15px; 
            margin-top: 10px;
        }

        /* O "Bubble" do Dia - Estilo de App Premium */
        .dia-bubble { 
            background: white;
            border: 2px solid #edf2f7;
            border-radius: 20px; /* Bordas bem arredondadas */
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }

        /* Estado Ativo: Eleva√ß√£o e Cor */
        .dia-bubble.active { 
            border-color: var(--iasd-blue);
            background-color: #f8faff;
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 51, 102, 0.1);
        }

        .dia-bubble .dia-nome { 
            display: block; 
            font-weight: 800; 
            font-size: 0.8rem;
            color: #94a3b8; 
            margin-bottom: 10px; 
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .dia-bubble.active .dia-nome { color: var(--iasd-blue); }

        /* Seletor Num√©rico flutuante */
        .pessoas-control { 
            background: #f1f5f9;
            border-radius: 12px;
            padding: 6px 10px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s ease;
        }

        .dia-bubble.active .pessoas-control {
            background: var(--iasd-blue);
            color: white;
        }

        .pessoas-control input { 
            width: 30px; 
            background: transparent;
            border: none;
            text-align: center;
            font-weight: bold;
            color: inherit;
            font-size: 1rem;
            outline: none;
        }

        /* Remove setas padr√£o do input num√©rico */
        .pessoas-control input::-webkit-inner-spin-button,
        .pessoas-control input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .label-unidade {
            font-size: 0.6rem;
            font-weight: 700;
            opacity: 0.6;
            text-transform: uppercase;
        }

        .dia-card.active { 
            border-color: var(--iasd-blue);
            background-color: var(--iasd-light-blue);
        }

        .dia-card .nome { display: block; font-weight: 800; color: var(--text-dark); margin-bottom: 5px; }
        .dia-card.active .nome { color: var(--iasd-blue); }
        .dia-card .label-pess { font-size: 0.65rem; color: #a0aec0; display: block; margin-bottom: 5px; }

        .dia-card input { 
            width: 50px; 
            padding: 5px; 
            border: 1px solid var(--border); 
            border-radius: 4px; 
            text-align: center; 
            font-weight: bold;
        }

        .btn-iasd { 
            background: var(--iasd-blue); 
            color: white; 
            border: none; 
            width: 100%; 
            padding: 18px; 
            border-radius: 8px; 
            font-weight: bold; 
            text-transform: uppercase; 
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 51, 102, 0.2);
        }

        .badge-membro {
            background: var(--iasd-blue);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.85rem;
        }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th { text-align: left; border-bottom: 2px solid var(--iasd-gold); padding: 10px; }
        td { padding: 10px; border-bottom: 1px solid var(--border); }


        /* Bal√£o Estilizado (Pop-up) */
        .menu-contexto {
            display: none; /* Escondido por padr√£o */
            position: absolute;
            z-index: 1000;
            width: 160px;
            background-color: #242832;
            background-image: linear-gradient(139deg, #242832 0%, #251c28 100%);
            border-radius: 8px;
            padding: 8px 0;
            box-shadow: 0 10px 15px rgba(0,0,0,0.3);
        }

        .menu-contexto ul { list-style: none; margin: 0; padding: 0; }

        .menu-contexto li {
            padding: 8px 12px;
            color: #7e8590;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: 0.2s;
        }

        .menu-contexto li:hover { background: #5353ff; color: #fff; }
        .menu-contexto li.delete:hover { background: #8e2a2a; }

        /* Indicador de Aten√ß√£o */
        .alerta-conflito {
            width: 8px;
            height: 8px;
            background: #e53e3e;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
            animation: pulse 1.5s infinite;
        }

        .nome-container {
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .nome-container:hover { background: rgba(0, 51, 102, 0.05); }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.3); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        @media (max-width: 600px) {
            .grid-inputs { grid-template-columns: 1fr; }
        }
        /* Bot√£o Voltar Estilizado */
        .btn-voltar-container {
            margin-bottom: 20px;
            display: inline-block;
        }

        .button-back {
            background-color: transparent;
            color: var(--iasd-blue);
            width: 8.5em;
            height: 2.9em;
            border: var(--iasd-blue) 0.15em solid; /* Borda um pouco mais fina para eleg√¢ncia */
            border-radius: 11px;
            text-align: right;
            transition: all 0.5s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            cursor: pointer;
            font-weight: 600;
            padding: 0;
        }

        .button-back:hover {
            background-color: var(--iasd-blue);
            color: #fff;
        }

        .button-back svg {
            width: 1.4em;
            left: 0.8em;
            position: absolute;
            transition: all 0.5s ease;
            /* Invertendo a seta para apontar para a esquerda */
            transform: rotate(180deg); 
        }

        .button-back:hover svg {
            transform: rotate(180deg) translateX(5px);
            stroke: #fff;
        }

        .button-back .text {
            margin: 0 1.2em;
        }

        /* Estiliza√ß√£o do aviso de conflito dentro do bal√£o escuro */
        .conflito-info {
            background: rgba(255, 255, 255, 0.1); /* Fundo levemente claro para destacar do preto */
            border-bottom: 1px solid rgba(255, 77, 77, 0.3);
            padding: 12px;
            margin-bottom: 5px;
            border-radius: 8px 8px 0 0;
            color: #ff8080; /* Vermelho claro/salm√£o para leitura no fundo escuro */
            font-size: 0.75rem;
            line-height: 1.4;
            text-align: center;
            font-weight: 600;
        }

        .conflito-info strong {
            color: #ff4d4d; /* Vermelho mais vivo para o "ATEN√á√ÉO" */
            display: block;
            margin-bottom: 4px;
            text-transform: uppercase;
            font-size: 0.65rem;
            letter-spacing: 1px;
        }
    </style>
</head>
<body>

<header>
    <p>IGREJA ADVENTISTA DO S√âTIMO DIA</p>
    <h1 id="headerTitle">SISTEMA DE GEST√ÉO DE ESCALAS</h1>
</header>

<div class="container">
   <div class="btn-voltar-container" style="margin-bottom: 20px;">
        <button class="button-back" onclick="voltarParaMembros()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12h15m0 0l-6.75-6.75M19.5 12l-6.75 6.75" />
            </svg>
            <div class="text">Voltar</div>
        </button>
    </div>
    
    <div class="card">
        <div class="section-header"><h3>üìñ Per√≠odo e Departamento</h3></div>
        <div class="grid-inputs">
            <div class="input-group">
                <label>Departamento Selecionado</label>
                <div id="displayDepto" style="font-weight: bold; color: var(--iasd-blue); padding: 12px; background: var(--iasd-light-blue); border-radius: 6px; border: 1.5px solid var(--border);">Carregando...</div>
            </div>
            <div class="input-group">
                <label>M√™s de Refer√™ncia</label>
                <input type="month" id="mesRef" onchange="atualizarDatasAutomaticas()">
            </div>
            <div class="input-group">
                <label>Data In√≠cio</label>
                <input type="date" id="dataInicio">
            </div>
            <div class="input-group">
                <label>Data Fim</label>
                <input type="date" id="dataFim">
            </div>
        </div>
    </div>

    <div class="card">
        <div class="section-header"><h3>‚öôÔ∏è Frequ√™ncia (Dias e Pessoas)</h3></div>
        <div class="frequencia-grid">
            <div class="dia-bubble active" onclick="toggleDia(this, 0)" data-dia="0">
                <span class="dia-nome">Dom</span>
                <div class="pessoas-control" onclick="event.stopPropagation()">
                    <input type="number" value="1" min="1">
                    <span class="label-unidade">Pessoa</span>
                </div>
            </div>

            <div class="dia-bubble" onclick="toggleDia(this, 1)" data-dia="1">
                <span class="dia-nome">Seg</span>
                <div class="pessoas-control" onclick="event.stopPropagation()">
                    <input type="number" value="1" min="1">
                    <span class="label-unidade">Pessoa</span>
                </div>
            </div>

            <div class="dia-bubble" onclick="toggleDia(this, 2)" data-dia="2">
                <span class="dia-nome">Ter</span>
                <div class="pessoas-control" onclick="event.stopPropagation()">
                    <input type="number" value="1" min="1">
                    <span class="label-unidade">Pessoa</span>
                </div>
            </div>

            <div class="dia-bubble active" onclick="toggleDia(this, 3)" data-dia="3">
                <span class="dia-nome">Qua</span>
                <div class="pessoas-control" onclick="event.stopPropagation()">
                    <input type="number" value="1" min="1">
                    <span class="label-unidade">Pessoa</span>
                </div>
            </div>

            <div class="dia-bubble" onclick="toggleDia(this, 4)" data-dia="4">
                <span class="dia-nome">Qui</span>
                <div class="pessoas-control" onclick="event.stopPropagation()">
                    <input type="number" value="1" min="1">
                    <span class="label-unidade">Pessoa</span>
                </div>
            </div>

            <div class="dia-bubble" onclick="toggleDia(this, 5)" data-dia="5">
                <span class="dia-nome">Sex</span>
                <div class="pessoas-control" onclick="event.stopPropagation()">
                    <input type="number" value="1" min="1">
                    <span class="label-unidade">Pessoa</span>
                </div>
            </div>

            <div class="dia-bubble active" onclick="toggleDia(this, 6)" data-dia="6">
                <span class="dia-nome">S√°b</span>
                <div class="pessoas-control" onclick="event.stopPropagation()">
                    <input type="number" value="1" min="1">
                    <span class="label-unidade">Pessoa</span>
                </div>
            </div>
        </div>
    </div>

    <button class="btn-iasd" onclick="gerarEscala()">Gerar Escala</button>

    <div class="card" id="cardResultado" style="margin-top: 20px; display: none;">
        <div class="section-header"><h3>üìÖ Escala Gerada</h3></div>
        <table>
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Dia</th>
                    <th>Respons√°veis</th>
                </tr>
            </thead>
            <tbody id="resultadoEscala"></tbody>
        </table>

        <div style="margin-top: 20px; text-align: center;">
        <button onclick="salvarEscalaNoFirebase()" class="btn-iasd" style="background-color: #28a745;">
            üíæ Salvar Escala Oficial
        </button>
    </div>

    </div>
</div>

<script>
    let listaMembrosOficiais = []; 
    
    const firebaseConfig = {
        apiKey: "AIzaSyBYtUnqsokLE1RnK1TGbswbnsLXPpvvdc0",
        authDomain: "escala7igreja.firebaseapp.com",
        databaseURL: "https://escala7igreja-default-rtdb.firebaseio.com",
        projectId: "escala7igreja",
        storageBucket: "escala7igreja.firebasestorage.app",
        messagingSenderId: "778312493987",
        appId: "1:778312493987:web:2851b2fc65331e4ac14816"
    };

    if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();

    const urlParams = new URLSearchParams(window.location.search);
    const deptoLogado = urlParams.get('depto') || "Geral";
    let diasAtivos = [0, 3, 6];

    function toggleDia(card, diaIndex) {
        card.classList.toggle('active');
        const dia = parseInt(diaIndex);
        if (card.classList.contains('active')) {
            if (!diasAtivos.includes(dia)) diasAtivos.push(dia);
        } else {
            diasAtivos = diasAtivos.filter(d => d !== dia);
        }
    }

    function atualizarDatasAutomaticas() {
        const mesRef = document.getElementById('mesRef').value;
        if(mesRef) {
            const [ano, mes] = mesRef.split('-');
            const primeiro = new Date(ano, mes - 1, 1);
            const ultimo = new Date(ano, mes, 0);
            const formatar = (data) => {
                const z = data.getTimezoneOffset() * 60 * 1000;
                const local = new Date(data - z);
                return local.toISOString().split('T')[0];
            };
            document.getElementById('dataInicio').value = formatar(primeiro);
            document.getElementById('dataFim').value = formatar(ultimo);
        }
    }

    window.onload = () => {
        document.getElementById('displayDepto').innerText = deptoLogado;
        if(document.getElementById('nomeDeptoBotao')) {
            document.getElementById('nomeDeptoBotao').innerText = deptoLogado;
        }
        
        const d = new Date();
        const ano = d.getFullYear();
        const mes = String(d.getMonth() + 1).padStart(2, '0'); // Garante 01, 02...
        
        document.getElementById('mesRef').value = `${ano}-${mes}`;
        atualizarDatasAutomaticas();
        carregarEscalaSalva();
    };

    async function gerarEscala() {
        const dataInicioVal = document.getElementById('dataInicio').value;
        const dataFimVal = document.getElementById('dataFim').value;
        const dataInicio = new Date(dataInicioVal + 'T00:00:00');
        const dataFim = new Date(dataFimVal + 'T00:00:00');

        try {
            const mesRef = document.getElementById('mesRef').value;
            const snapshotTodasEscalas = await db.ref("escalas_salvas").once("value");
            const todasEscalasDoMes = snapshotTodasEscalas.val() || {};

            const snapshotMembros = await db.ref("equipes_deptos").once("value");
            let voluntarios = [];
            listaMembrosOficiais = []; 
            
            snapshotMembros.forEach(child => {
                const dados = child.val();
                if (dados.departamento === deptoLogado) {
                    const nomeFinal = dados.nomeExibicao || dados.nomeCompleto || "Sem Nome";
                    voluntarios.push({
                        id: child.key,
                        nome: nomeFinal, 
                        vezesEscalado: 0,
                        disponibilidade: dados.disponibilidade || [] 
                    });
                    if(!listaMembrosOficiais.includes(nomeFinal)) {
                        listaMembrosOficiais.push(nomeFinal);
                    }
                }
            });

            if (voluntarios.length === 0) {
                alert("Nenhum membro encontrado para: " + deptoLogado);
                return;
            }

            let corpoTabela = "";
            let dataAtual = new Date(dataInicio);
            let ultimoSorteadoId = null;
            const diasNome = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"];

            while (dataAtual <= dataFim) {
                const diaSemana = dataAtual.getDay();
                
                // --- AJUSTE DE DATA ---
                // dataParaBusca: Usada para comparar com o Firebase (cont√©m o ano)
                const dataParaBusca = dataAtual.toLocaleDateString('pt-BR'); 
                
                // dataParaExibicao: Usada para mostrar na tabela (sem o ano)
                const dia = String(dataAtual.getDate()).padStart(2, '0');
                const mes = String(dataAtual.getMonth() + 1).padStart(2, '0');
                const dataParaExibicao = `${dia}/${mes}`;

                if (diasAtivos.includes(diaSemana)) {
                    const bubbleDia = document.querySelector(`.dia-bubble[data-dia="${diaSemana}"]`);
                    const qtdPessoasInput = bubbleDia ? bubbleDia.querySelector('input').value : 1;
                    const qtdPessoas = parseInt(qtdPessoasInput) || 1;

                    let escaladosNoDia = [];

                    for (let i = 0; i < qtdPessoas; i++) {
                        let aptos = voluntarios.filter(v => {
                            const disp = Array.isArray(v.disponibilidade) ? v.disponibilidade : Object.values(v.disponibilidade);
                            return disp.map(Number).includes(diaSemana) && !escaladosNoDia.includes(v.id);
                        });

                        if (aptos.length > 0) {
                            let listaCandidatos = aptos.map(v => {
                                let deptosConflitantes = [];
                                Object.keys(todasEscalasDoMes).forEach(depto => {
                                    if (depto !== deptoLogado && todasEscalasDoMes[depto][mesRef]) {
                                        // Compara usando a data com ano para garantir o match no banco
                                        const jaEscalado = todasEscalasDoMes[depto][mesRef].corpo.some(item => 
                                            item.data === dataParaBusca && item.nome === v.nome
                                        );
                                        if (jaEscalado) deptosConflitantes.push(depto);
                                    }
                                });
                                return { ...v, conflitos: deptosConflitantes };
                            });

                            let semConflito = listaCandidatos.filter(v => v.conflitos.length === 0);
                            let listaFinal = semConflito.length > 0 ? semConflito : listaCandidatos;

                            const minEscalas = Math.min(...listaFinal.map(v => v.vezesEscalado));
                            let candidatosFinais = listaFinal.filter(v => v.vezesEscalado === minEscalas);
                            
                            if (candidatosFinais.length > 1) {
                                candidatosFinais = candidatosFinais.filter(v => v.id !== ultimoSorteadoId);
                            }

                            const sorteado = candidatosFinais[Math.floor(Math.random() * candidatosFinais.length)];

                            sorteado.vezesEscalado++;
                            ultimoSorteadoId = sorteado.id;
                            escaladosNoDia.push(sorteado.id);

                            const temAlerta = sorteado.conflitos && sorteado.conflitos.length > 0;

                            corpoTabela += `
                                <tr>
                                    <td>${i === 0 ? `<strong>${dataParaExibicao}</strong>` : ''}</td>
                                    <td style="color: #718096;">${i === 0 ? diasNome[diaSemana] : ''}</td>
                                    <td>
                                        <div class="nome-container" 
                                            onclick="toggleMenu(event, this)" 
                                            data-conflitos="${temAlerta ? sorteado.conflitos.join(', ') : ''}"
                                            data-data-real="${dataParaBusca}"> ${temAlerta ? '<span class="alerta-conflito"></span>' : ''}
                                            <span class="texto-nome" style="font-weight: 600; color: ${temAlerta ? '#e53e3e' : 'var(--iasd-blue)'};">
                                                ${sorteado.nome}
                                            </span>
                                        </div>
                                        
                                        <div class="menu-contexto">
                                            <div class="conflito-info" style="display:none;"></div> 
                                            <ul>
                                                <li onclick="ativarEdicao(this)"><span>‚úé</span> Editar</li>
                                                <li class="delete" onclick="excluirLinha(this)"><span>üóë</span> Excluir</li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>`;
                        }
                    }
                }
                dataAtual.setDate(dataAtual.getDate() + 1);
            }
            
            document.getElementById('resultadoEscala').innerHTML = corpoTabela;
            document.getElementById('cardResultado').style.display = 'block';

        } catch (error) {
            console.error("Erro ao gerar escala:", error);
            alert("Erro ao ler dados: " + error.message);
        }
    }

    // --- FUN√á√ïES DE CONTROLE DO MENU E EDI√á√ÉO ---

    function toggleMenu(event, elemento) {
        event.stopPropagation();
        
        // Fecha outros menus
        document.querySelectorAll('.menu-contexto').forEach(m => m.style.display = 'none');

        const menu = elemento.nextElementSibling;
        const conflitos = elemento.getAttribute('data-conflitos');
        
        // Verifica se j√° existe a div de aviso, se n√£o, cria
        let areaAviso = menu.querySelector('.conflito-info');
        if (!areaAviso) {
            areaAviso = document.createElement('div');
            areaAviso.className = 'conflito-info';
            menu.prepend(areaAviso);
        }

        if (conflitos && conflitos.trim() !== "") {
            areaAviso.innerHTML = `<strong>‚ö†Ô∏è Aten√ß√£o</strong>J√° escalado em: ${conflitos}`;
            areaAviso.style.display = 'block';
        } else {
            areaAviso.style.display = 'none';
        }

        menu.style.display = 'block';

        const fecharMenu = () => {
            menu.style.display = 'none';
            document.removeEventListener('click', fecharMenu);
        };
        document.addEventListener('click', fecharMenu);
    }

    function ativarEdicao(itemMenu) {
        const td = itemMenu.closest('td');
        const containerNome = td.querySelector('.nome-container');
        const textoNomeSpan = containerNome.querySelector('.texto-nome');
        const nomeAtual = textoNomeSpan.innerText;

        // Fecha o menu
        td.querySelector('.menu-contexto').style.display = 'none';

        const idLista = "lista_" + Math.floor(Math.random() * 1000);
        const opcoes = listaMembrosOficiais.map(n => `<option value="${n}">`).join('');

        // Substitui o conte√∫do do container apenas pelo input
        containerNome.innerHTML = `
            <div style="display: flex; gap: 5px; width: 100%;" onclick="event.stopPropagation()">
                <input type="text" list="${idLista}" id="inputEdit" value="${nomeAtual}" 
                    style="padding: 5px; border: 1px solid var(--iasd-gold); border-radius: 4px; width: 120px; font-size: 0.8rem;">
                <datalist id="${idLista}">${opcoes}</datalist>
                <button onclick="confirmarEdicao(this)" style="background: var(--iasd-blue); color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.7rem;">OK</button>
            </div>
        `;
        
        // Remove temporariamente o clique do container para n√£o abrir o menu enquanto edita
        containerNome.onclick = (e) => e.stopPropagation();
    }

    async function confirmarEdicao(botao) {
        const novoNome = botao.parentElement.querySelector('#inputEdit').value;
        const containerNome = botao.closest('.nome-container');
        const dataReal = containerNome.getAttribute('data-data-real');
        
        if (novoNome.trim() !== "") {
            // 1. Verifica conflitos para o NOVO nome inserido
            const conflitos = await verificarNovoConflito(novoNome, dataReal);
            const temAlerta = conflitos.length > 0;

            // 2. Atualiza os metadados do container
            containerNome.setAttribute('data-conflitos', temAlerta ? conflitos.join(', ') : '');

            // 3. Reconstr√≥i o HTML interno (Limpando ou Adicionando a bolinha)
            containerNome.innerHTML = `
                ${temAlerta ? '<span class="alerta-conflito"></span>' : ''}
                <span class="texto-nome" style="font-weight: 600; color: ${temAlerta ? '#e53e3e' : 'var(--iasd-blue)'};">
                    ${novoNome}
                </span>
            `;
            
            // 4. Devolve o evento de clique para o menu
            setTimeout(() => {
                containerNome.onclick = (event) => toggleMenu(event, containerNome);
            }, 100);
        }
    }

    function excluirLinha(itemMenu) {
        // Para a propaga√ß√£o para n√£o abrir o menu ou disparar outros cliques
        if (event) event.stopPropagation();

        if(confirm("Deseja remover este registro da escala?")) {
            // Busca a linha (tr) mais pr√≥xima a partir do item clicado
            const linha = itemMenu.closest('tr');
            if (linha) {
                linha.remove();
            }
        }
        
        // Fecha qualquer menu que esteja aberto
        document.querySelectorAll('.menu-contexto').forEach(m => m.style.display = 'none');
    }

    function voltarParaMembros() {
        window.location.href = `membros.html?depto=${encodeURIComponent(deptoLogado)}`;
    }

    async function salvarEscalaNoFirebase() {
        const mesRef = document.getElementById('mesRef').value;
        const linhas = document.querySelectorAll('#resultadoEscala tr');
        let dadosParaSalvar = [];

        if (linhas.length === 0) return alert("Gere uma escala antes de salvar!");

        linhas.forEach(linha => {
            // BUSCA A DATA REAL: Tenta pegar do atributo oculto; se n√£o existir (ex: linhas vazias), pega o texto
            const containerNome = linha.querySelector('.nome-container');
            const dataCompleta = containerNome ? containerNome.getAttribute('data-data-real') : linha.cells[0].innerText.replace(/<[^>]*>?/gm, '');
            
            const diaSemana = linha.cells[1].innerText;
            const nomeElemento = linha.querySelector('.texto-nome');
            
            if (nomeElemento) {
                const nome = nomeElemento.innerText;
                dadosParaSalvar.push({ 
                    data: dataCompleta, // Aqui garantimos o formato "DD/MM/AAAA"
                    diaSemana, 
                    nome 
                });
            }
        });

        try {
            await db.ref("escalas_salvas").child(deptoLogado).child(mesRef).set({
                ultimaAtualizacao: new Date().toISOString(),
                corpo: dadosParaSalvar
            });

            alert("‚úÖ Escala salva com sucesso! O ano foi preservado para evitar conflitos futuros.");
        } catch (error) {
            console.error("Erro ao salvar:", error);
            alert("Erro ao salvar escala.");
        }
    }

    async function carregarEscalaSalva() {
        const mesRef = document.getElementById('mesRef').value;
        
        try {
            const snapshot = await db.ref("escalas_salvas").child(deptoLogado).child(mesRef).once("value");
            const dados = snapshot.val();

            if (dados && dados.corpo) {
                let corpoTabela = "";
                dados.corpo.forEach(item => {
                    corpoTabela += `
                        <tr>
                            <td>${mostrarData ? `<strong>${item.data}</strong>` : ''}</td>
                            <td style="color: #718096;">${mostrarData ? item.diaSemana : ''}</td>
                            <td>
                                <div class="nome-container" 
                                    onclick="toggleMenu(event, this)" 
                                    data-conflitos="" 
                                    data-data-real="${item.data}"> <span class="texto-nome" style="font-weight: 600; color: var(--iasd-blue);">${item.nome}</span>
                                </div>
                                ...
                            </td>
                        </tr>`;
                });
                
                document.getElementById('resultadoEscala').innerHTML = corpoTabela;
                document.getElementById('cardResultado').style.display = 'block';
                alert("üìÖ Escala salva encontrada e carregada!");
            } else {
                // Se n√£o houver escala, apenas limpa para gerar uma nova
                document.getElementById('cardResultado').style.display = 'none';
            }
        } catch (error) {
            console.error("Erro ao carregar:", error);
        }
    }

    async function carregarEscalaSalva() {
        const mesRef = document.getElementById('mesRef').value; // Pega o m√™s selecionado (ex: 2026-02)
        
        // Mostra um aviso visual de que est√° buscando
        const tabela = document.getElementById('resultadoEscala');
        tabela.innerHTML = "<tr><td colspan='3' style='text-align:center;'>Buscando escala no banco de dados...</td></tr>";
        document.getElementById('cardResultado').style.display = 'block';

        try {
            // Caminho: escalas_salvas > Som > 2026-02
            const snapshot = await db.ref("escalas_salvas").child(deptoLogado).child(mesRef).once("value");
            const dados = snapshot.val();

            if (dados && dados.corpo) {
                let corpoTabela = "";
                
                // "item" aqui ter√°: data, diaSemana e nome (conforme seu Firebase)
                dados.corpo.forEach((item, index) => {
                    // Verificamos se √© a primeira linha de uma data para n√£o repetir o texto da data/dia (opcional)
                    const mostrarData = (index === 0 || dados.corpo[index-1].data !== item.data);

                    corpoTabela += `
                        <tr>
                            <td>${mostrarData ? `<strong>${item.data}</strong>` : ''}</td>
                            <td style="color: #718096;">${mostrarData ? item.diaSemana : ''}</td>
                            <td>
                                <div class="nome-container" onclick="toggleMenu(event, this)">
                                    <span class="texto-nome" style="font-weight: 600; color: var(--iasd-blue);">${item.nome}</span>
                                </div>
                                <div class="menu-contexto">
                                    <ul>
                                        <li onclick="ativarEdicao(this)"><span>‚úé</span> Editar</li>
                                        <li class="delete" onclick="excluirLinha(this)"><span>üóë</span> Excluir</li>
                                    </ul>
                                </div>
                            </td>
                        </tr>`;
                });
                
                tabela.innerHTML = corpoTabela;
                console.log("Escala carregada do Firebase!");
            } else {
                // Se n√£o encontrar nada, esconde o card e avisa que pode gerar uma nova
                document.getElementById('cardResultado').style.display = 'none';
                console.log("Nenhuma escala salva encontrada para este m√™s.");
            }
        } catch (error) {
            console.error("Erro ao carregar:", error);
            alert("Erro ao carregar escala salva.");
        }
    }

    async function verificarNovoConflito(nome, dataReal) {
        const mesRef = document.getElementById('mesRef').value;
        const snapshot = await db.ref("escalas_salvas").once("value");
        const todasEscalas = snapshot.val() || {};
        let conflitos = [];

        Object.keys(todasEscalas).forEach(depto => {
            if (depto !== deptoLogado && todasEscalas[depto][mesRef]) {
                const jaEscalado = todasEscalas[depto][mesRef].corpo.some(item => 
                    item.data === dataReal && item.nome === nome
                );
                if (jaEscalado) conflitos.push(depto);
            }
        });
        return conflitos;
    }
</script>
</body>
</html>
