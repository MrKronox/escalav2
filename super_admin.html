<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super ADM - Gest√£o de Base Global</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    
    <link rel="manifest" href="manifest.json">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icone-app.png">

    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('Service Worker registrado com sucesso!'))
            .catch(err => console.error('Falha ao registrar Service Worker:', err));
        });
    }
    </script>
    
    
    <style>
        :root { --admin-red: #800000; --iasd-blue: #003366; --iasd-gold: #c5a059; }
        body { font-family: 'Poppins', sans-serif; background: #f0f2f5; margin: 0; color: #2d3748; }
        
        header { 
            background: var(--admin-red); color: white; padding: 25px 15px; 
            text-align: center; border-bottom: 5px solid var(--iasd-gold); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); 
        }
        header h1 { font-size: 1.5rem; margin: 0; }
        header p { font-size: 0.9rem; margin-top: 5px; }

        .container { max-width: 900px; margin: 10px auto; padding: 10px; box-sizing: border-box; }
        
        .card { 
            background: white; border-radius: 15px; padding: 20px; 
            margin-bottom: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); 
        }

        h2 { color: var(--iasd-blue); margin-top: 0; display: flex; align-items: center; gap: 10px; font-size: 1.2rem; }
        h3 { font-size: 1rem; color: var(--iasd-blue); }

        /* AJUSTE MOBILE: Grids que empilham no celular */
        .responsive-grid {
            display: grid;
            grid-template-columns: 1fr; /* Uma coluna por padr√£o (celular) */
            gap: 15px;
        }

        /* Se a tela for maior que 600px, usa duas colunas */
        @media (min-width: 600px) {
            .responsive-grid { grid-template-columns: 1fr 1fr; }
            header h1 { font-size: 2rem; }
        }

        .form-group { margin-bottom: 10px; display: flex; flex-direction: column; }
        label { font-weight: 600; margin-bottom: 6px; font-size: 0.85rem; color: #4a5568; }
        
        input, select { 
            padding: 12px; border: 2px solid #edf2f7; border-radius: 10px; 
            font-size: 1rem; transition: 0.3s; width: 100%; box-sizing: border-box;
        }
        
        input:focus { border-color: var(--iasd-blue); outline: none; }
        
        .btn-action { 
            background: var(--iasd-blue); color: white; border: none; padding: 14px; 
            border-radius: 10px; cursor: pointer; font-weight: bold; width: 100%; 
            transition: 0.3s; font-size: 1rem;
        }
        .btn-action:hover { opacity: 0.9; transform: translateY(-2px); }
        
        /* Tabela Estilizada com Scroll Mobile */
        .table-container { 
            overflow-x: auto; 
            margin-top: 10px;
            -webkit-overflow-scrolling: touch; /* Scroll suave no iOS */
        }
        
        table { width: 100%; border-collapse: collapse; min-width: 500px; } /* Mant√©m largura m√≠nima para n√£o esmagar dados */
        th { background: #f8fafc; text-align: left; padding: 12px; color: #718096; font-size: 0.75rem; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid #edf2f7; font-size: 0.9rem; vertical-align: middle; }
        
        .search-box { margin-bottom: 15px; width: 100%; box-sizing: border-box; padding: 12px; border: 2px solid #edf2f7; border-radius: 10px; }

        /* Estilo para lista de cargos */
        .depto-list-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; background: #f8fafc; border-radius: 8px; margin-bottom: 8px;
            border-left: 4px solid var(--iasd-gold);
        }
        .depto-info { flex-grow: 1; }
        .btn-delete-small {
            background: #e53e3e; color: white; border: none; padding: 8px 12px;
            border-radius: 5px; cursor: pointer; font-size: 0.75rem; font-weight: bold;
            margin-left: 10px;
        }
    </style>
</head>
<body>

<header>
    <h1>SUPER ADMINISTRADOR</h1>
    <p>Gest√£o da Base de Dados de Membros e Acessos</p>
</header>

<div class="container">
    
    <div class="card">
        <h2>üîë Configurar Acessos e Lideran√ßa</h2>
        <p style="font-size: 0.8rem; color: #718096; margin-bottom: 15px;">Selecione o departamento para editar ou criar um novo acesso.</p>
        
        <div class="responsive-grid">
            <div class="form-group">
                <label>Departamento</label>
                <select id="selDeptoConfig" onchange="carregarConfigDepto()">
                    <option value="T√©cnico de Som">T√©cnico de Som</option>
                    <option value="Prega√ß√£o">Prega√ß√£o</option>
                    <option value="Louvor">Louvor</option>
                    <option value="Di√°conos">Di√°conos</option>
                    <option value="Escola Sabatina">Escola Sabatina</option>
                    <option value="Infantil">Infantil</option>
                    <option value="Recep√ß√£o">Recep√ß√£o</option>
                    <option value="Limpeza">Limpeza</option>
                </select>
            </div>
            <div class="form-group">
                <label>Senha de Acesso</label>
                <input type="text" id="passDepto" placeholder="Defina a senha">
            </div>
        </div>
        
        <div class="responsive-grid">
            <div class="form-group">
                <label>L√≠der Respons√°vel</label>
                <input type="text" id="nomeLider" list="listaMembrosSugestao" placeholder="Nome do L√≠der">
            </div>
            <div class="form-group">
                <label>Vice-L√≠der</label>
                <input type="text" id="nomeViceLider" list="listaMembrosSugestao" placeholder="Nome do Vice">
            </div>
        </div>

        <button class="btn-action" onclick="salvarConfiguracoes()" style="margin-top: 15px;">Atualizar Lideran√ßa e Senha</button>
        
        <hr style="margin: 25px 0; border: 0; border-top: 1px solid #edf2f7;">
        
        <h3>Cargos Ativos no Sistema</h3>
        <div id="listaDeptosAtivos"></div>
    </div>

    <div class="card">
        <h2>üë§ Adicionar √† Base Mestra</h2>
        <div class="responsive-grid">
            <div class="form-group">
                <label>Nome Completo (Registro)</label>
                <input type="text" id="novoMembroNome" placeholder="Ex: Jo√£o Silva...">
            </div>
            <div class="form-group">
                <label>Apelido / Nome de Exibi√ß√£o</label>
                <input type="text" id="novoMembroApelido" placeholder="Ex: Jo√£o">
            </div>
        </div>
        <button class="btn-action" style="background: #2d3748; margin-top: 10px;" onclick="cadastrarMembroMestra()">Adicionar Membro</button>
    </div>

    <div class="card">
        <h2>üìã Base de Dados Global de Membros</h2>
        <input type="text" id="inputBusca" class="search-box" placeholder="üîç Buscar membro na base..." onkeyup="filtrarTabela()">
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Nome do Membro</th>
                        <th>Status</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody id="listaMembrosMestra"></tbody>
            </table>
        </div>
    </div>

</div>

<datalist id="listaMembrosSugestao"></datalist>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBYtUnqsokLE1RnK1TGbswbnsLXPpvvdc0",
        authDomain: "escala7igreja.firebaseapp.com",
        databaseURL: "https://escala7igreja-default-rtdb.firebaseio.com",
        projectId: "escala7igreja",
        storageBucket: "escala7igreja.firebasestorage.app",
        messagingSenderId: "778312493987",
        appId: "1:778312493987:web:2851b2fc65331e4ac14816"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    async function cadastrarMembroMestra() {
        const nomeCompleto = document.getElementById('novoMembroNome').value.trim();
        const nomeExibicao = document.getElementById('novoMembroApelido').value.trim();
        if(!nomeCompleto || !nomeExibicao) return alert("Preencha o nome completo e o apelido.");

        try {
            await db.ref("membros").push({
                nomeCompleto: nomeCompleto,
                nomeExibicao: nomeExibicao,
                dataCadastro: new Date().toLocaleDateString('pt-BR')
            });
            document.getElementById('novoMembroNome').value = "";
            document.getElementById('novoMembroApelido').value = "";
            alert("Membro cadastrado com sucesso!");
        } catch (e) { alert("Erro ao cadastrar: " + e.message); }
    }

    function carregarDados() {
        db.ref("configuracoes/departamentos").on('value', snapDepto => {
            const configs = snapDepto.val() || {};
            let htmlDeptosAtivos = "";
            Object.keys(configs).forEach(deptoNome => {
                const d = configs[deptoNome];
                const viceExibicao = (d.viceLider && d.viceLider !== "N√£o definido") ? d.viceLider : "Nenhum";

                htmlDeptosAtivos += `
                    <div class="depto-list-item">
                        <div class="depto-info">
                            <strong>${deptoNome}</strong><br>
                            <small>L√≠der: ${d.liderResponsavel}</small><br>
                            <small>Vice: ${viceExibicao}</small>
                        </div>
                        <button class="btn-delete-small" onclick="removerConfigDepto('${deptoNome}')">üóëÔ∏è Remover</button>
                    </div>`;
            });
            document.getElementById('listaDeptosAtivos').innerHTML = htmlDeptosAtivos || "<p>Nenhum cargo configurado.</p>";

            db.ref("membros").on('value', snapMembros => {
                let htmlTabela = "";
                let htmlSugestao = "";
                const membros = snapMembros.val();
                
                if (membros) {
                    Object.keys(membros).forEach(key => {
                        const m = membros[key];
                        const nomeComp = m.nomeCompleto || "Sem Nome";
                        let cargos = [];
                        Object.keys(configs).forEach(dNome => {
                            if(configs[dNome].liderResponsavel === nomeComp) cargos.push(`‚≠ê L√≠der: ${dNome}`);
                            if(configs[dNome].viceLider === nomeComp) cargos.push(`ü•à Vice: ${dNome}`);
                        });

                        const labelCargos = cargos.length > 0 
                            ? `<div style="margin-top:5px;">${cargos.map(c => `<span style="background:#fff3cd; color:#856404; font-size:0.7rem; padding:2px 6px; border-radius:4px; margin-right:5px; border:1px solid #ffeeba;">${c}</span>`).join('')}</div>` 
                            : "";

                        htmlTabela += `
                            <tr>
                                <td>
                                    <strong>${nomeComp}</strong><br>
                                    <small style="color: #718096;">Apelido: ${m.nomeExibicao || "-"}</small>
                                    ${labelCargos}
                                </td>
                                <td><span style="color:#2ecc71; font-size:0.8rem">‚óè Ativo</span></td>
                                <td>
                                    <button onclick="removerMembro('${key}')" style="color:#e53e3e; border:none; background:none; cursor:pointer; font-weight:bold;">üóë Excluir</button>
                                </td>
                            </tr>`;
                        htmlSugestao += `<option value="${nomeComp}">${m.nomeExibicao}</option>`;
                    });
                }
                document.getElementById('listaMembrosMestra').innerHTML = htmlTabela;
                document.getElementById('listaMembrosSugestao').innerHTML = htmlSugestao;
            });
        });
    }

    async function salvarConfiguracoes() {
        const depto = document.getElementById('selDeptoConfig').value;
        const senha = document.getElementById('passDepto').value;
        const lider = document.getElementById('nomeLider').value;
        const vice = document.getElementById('nomeViceLider').value;
        if(!senha || !lider) return alert("A senha e o L√≠der s√£o obrigat√≥rios.");

        await db.ref(`configuracoes/departamentos/${depto}`).set({
            senha: senha, liderResponsavel: lider, viceLider: vice || "N√£o definido"
        });
        alert(`Lideran√ßa de ${depto} atualizada com sucesso!`);
    }

    async function removerConfigDepto(nomeDepto) {
        if(confirm(`Deseja remover o acesso do departamento "${nomeDepto}"?`)) {
            try {
                await db.ref(`configuracoes/departamentos/${nomeDepto}`).remove();
                alert("Acesso removido!");
            } catch (e) { alert("Erro: " + e.message); }
        }
    }

    async function removerMembro(id) {
        if (confirm("Deseja realmente remover este membro da base global?")) {
            await db.ref(`membros/${id}`).remove();
        }
    }

    function filtrarTabela() {
        const busca = document.getElementById('inputBusca').value.toLowerCase();
        const linhas = document.querySelectorAll('#listaMembrosMestra tr');
        linhas.forEach(linha => {
            const nome = linha.querySelector('td').innerText.toLowerCase();
            linha.style.display = nome.includes(busca) ? "" : "none";
        });
    }

    function carregarConfigDepto() {
        const depto = document.getElementById('selDeptoConfig').value;
        db.ref(`configuracoes/departamentos/${depto}`).once('value', snap => {
            const d = snap.val();
            document.getElementById('passDepto').value = d ? d.senha : "";
            document.getElementById('nomeLider').value = d ? d.liderResponsavel : "";
            document.getElementById('nomeViceLider').value = (d && d.viceLider !== "N√£o definido") ? d.viceLider : "";
        });
    }

    window.onload = () => { carregarDados(); carregarConfigDepto(); };
</script>
</body>
</html>
