<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Escalas - IASD</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    
    <link rel="manifest" href="manifest.json">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icone-app.png">

    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('Service Worker registrado com sucesso!'))
            .catch(err => console.error('Falha ao registrar Service Worker:', err));
        });
    }
    </script>
    
    
    
    <style>
        :root { 
            --iasd-blue: #003366; 
            --iasd-gold: #c5a059; 
            --bg: #f8fafc; 
            --danger: #ef4444;
            --text-main: #1e293b;
        }

        body { font-family: 'Inter', 'Segoe UI', sans-serif; background: var(--bg); margin: 0; color: var(--text-main); }
        
        header { 
            background: var(--iasd-blue); color: white; padding: 30px 15px; text-align: center;
            border-bottom: 6px solid var(--iasd-gold); box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .container { padding: 20px; max-width: 480px; margin: auto; }

        /* Card Pr√≥ximo Culto - Layout id√™ntico ao index */
        .card-proximo {
            background: white; border-radius: 20px; padding: 25px;
            box-shadow: 0 10px 30px rgba(0,51,102,0.05); margin-bottom: 30px;
            border-left: 6px solid var(--iasd-gold);
        }
        .card-proximo h2 { 
            color: var(--iasd-blue); font-size: 0.85rem; margin: 0 0 20px; 
            text-transform: uppercase; letter-spacing: 1.5px; border-bottom: 1px solid #f1f5f9;
            padding-bottom: 12px; font-weight: 800;
        }

        .linha-escala {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 0; border-bottom: 1px dashed #e2e8f0;
        }
        .linha-escala:last-child { border-bottom: none; }
        .depto-txt { font-weight: 500; color: #64748b; font-size: 0.9rem; }
        .pessoa-txt { font-weight: 700; color: var(--iasd-blue); font-size: 1rem; cursor: pointer; }

        /* Bal√µes de Pesquisa Modernos */
        .search-container {
            background: white; padding: 25px; border-radius: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 20px;
            border: 1px solid #f1f5f9;
        }
        .search-group { margin-bottom: 18px; position: relative; }
        .search-group label { 
            display: block; font-size: 0.75rem; font-weight: 700; color: var(--iasd-blue);
            margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .search-group input { 
            width: 100%; padding: 14px 18px; border: 2px solid #f1f5f9; border-radius: 14px;
            box-sizing: border-box; font-size: 1rem; transition: 0.3s; background: #f8fafc;
        }
        .search-group input:focus { border-color: var(--iasd-gold); outline: none; background: white; }

        /* Resultados da busca refinados */
        .result-item {
            background: white; margin-bottom: 8px; padding: 15px 20px; border-radius: 16px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02); border: 1px solid #f1f5f9;
        }
        .data-tag { font-weight: 800; color: #64748b; font-size: 0.85rem; }
        .depto-tag { font-weight: 600; color: var(--iasd-blue); margin-left: 8px; }
        .btn-ver { color: var(--iasd-gold); font-weight: 800; font-size: 0.8rem; text-transform: uppercase; cursor: pointer; }

        /* Modal Estilizado */
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(15, 23, 42, 0.9); z-index: 1000; align-items: center; justify-content: center; 
            backdrop-filter: blur(8px);
        }
        .modal-content { 
            background: white; padding: 35px; border-radius: 28px; width: 85%; max-width: 320px; 
            text-align: center; border-top: 8px solid var(--iasd-gold);
        }
        .alerta-circle { 
            width: 60px; height: 60px; background: #fee2e2; color: var(--danger);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            margin: 0 auto 15px; font-size: 1.5rem;
        }


        /* Bot√£o Voltar Estilizado */
        .btn-voltar-container {
            margin-bottom: 20px;
            display: inline-block;
        }

        .button-back {
            background-color: transparent;
            color: var(--iasd-blue);
            width: 8.5em;
            height: 2.9em;
            border: var(--iasd-blue) 0.15em solid; /* Borda um pouco mais fina para eleg√¢ncia */
            border-radius: 11px;
            text-align: right;
            transition: all 0.5s ease;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            cursor: pointer;
            font-weight: 600;
            padding: 0;
        }

        .button-back:hover {
            background-color: var(--iasd-blue);
            color: #fff;
        }

        .button-back svg {
            width: 1.4em;
            left: 0.8em;
            position: absolute;
            transition: all 0.5s ease;
            /* Invertendo a seta para apontar para a esquerda */
            transform: rotate(180deg); 
        }

        .button-back:hover svg {
            transform: rotate(180deg) translateX(5px);
            stroke: #fff;
        }

        .button-back .text {
            margin: 0 1.2em;
        }
    </style>
</head>
<body>

<header>
    <p style="font-size: 0.65rem; letter-spacing: 4px; opacity: 0.8; margin: 0;">IGREJA ADVENTISTA</p>
    <h1 style="margin: 8px 0 0; font-size: 1.4rem; letter-spacing: 1px;">PORTAL DE ESCALAS</h1>
</header>



<div class="container">
    <div class="btn-voltar-container">
            <button class="button-back" onclick="window.location.href='index.html'" style="width: 8em;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" style="transform: rotate(0deg);">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                </svg>
                <span class="text">Home</span>
            </button>
        </div>
        
    <div class="card-proximo">
        <h2 id="tituloCard">Pr√≥ximo Culto</h2>
        <div id="listaProximo">Carregando informa√ß√µes...</div>
    </div>

    <div class="search-container">
        <div class="search-group">
            <label>üîé Buscar Volunt√°rio</label>
            <input type="text" id="filtroNome" placeholder="Digite um nome..." oninput="realizarBusca()">
        </div>
        <div class="search-group" style="margin-bottom: 0;">
            <label>üìÖ Filtrar por Data</label>
            <input type="date" id="filtroData" onchange="realizarBusca()">
        </div>
    </div>

    <div id="resultadosBusca"></div>
</div>

<div id="modalDetalhes" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div id="modalIcon"></div>
        <h3 id="mNome" style="margin: 0; color: var(--iasd-blue); font-size: 1.3rem;"></h3>
        <p id="mData" style="color: #64748b; font-weight: 600; margin: 5px 0 20px;"></p>
        <div id="mDeptos" style="text-align: left; background: #f8fafc; padding: 15px; border-radius: 12px;"></div>
        <button onclick="document.getElementById('modalDetalhes').style.display='none'" 
                style="margin-top: 25px; width: 100%; padding: 15px; border: none; background: var(--iasd-blue); color: white; border-radius: 12px; font-weight: 700; cursor: pointer;">
            FECHAR
        </button>
    </div>
</div>

<script>
    // Configura√ß√£o do Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBYtUnqsokLE1RnK1TGbswbnsLXPpvvdc0",
        authDomain: "escala7igreja.firebaseapp.com",
        databaseURL: "https://escala7igreja-default-rtdb.firebaseio.com",
        projectId: "escala7igreja",
        storageBucket: "escala7igreja.firebasestorage.app",
        messagingSenderId: "778312493987",
        appId: "1:778312493987:web:2851b2fc65331e4ac14816"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let escalasCache = {};

    async function iniciar() {
        const snap = await db.ref("escalas_salvas").once('value');
        escalasCache = snap.val() || {};
        definirProximoCulto();
    }

    function definirProximoCulto() {
        const agora = new Date();
        const diasCulto = [0, 3, 6]; 
        let dataAlvo = new Date(agora);
        
        if (agora.getHours() >= 20) dataAlvo.setDate(dataAlvo.getDate() + 1);
        while (!diasCulto.includes(dataAlvo.getDay())) { dataAlvo.setDate(dataAlvo.getDate() + 1); }

        const nomesDias = ["DOMINGO", "SEGUNDA", "TER√áA", "QUARTA-FEIRA", "QUINTA", "SEXTA", "S√ÅBADO"];
        document.getElementById('tituloCard').innerText = `ESCALA DE ${nomesDias[dataAlvo.getDay()]}`;
        
        const dataStr = dataAlvo.toLocaleDateString('pt-BR');
        renderizarCardHoje(dataStr);
    }

    function renderizarCardHoje(dataRef) {
        const lista = document.getElementById('listaProximo');
        lista.innerHTML = "";
        
        // Objeto para verificar conflitos (se a mesma pessoa est√° em mais de um depto)
        let mapaConflitos = {}; 

        // 1. Primeiro passo: Mapear quem est√° escalado em qu√™ para detectar conflitos
        for (let depto in escalasCache) {
            for (let mes in escalasCache[depto]) {
                const itensDoDia = (escalasCache[depto][mes].corpo || []).filter(i => i.data === dataRef);
                itensDoDia.forEach(item => {
                    if (!mapaConflitos[item.nome]) mapaConflitos[item.nome] = [];
                    mapaConflitos[item.nome].push(depto);
                });
            }
        }

        // 2. Segundo passo: Renderizar a lista por Departamento (mostrando todos os nomes)
        for (let depto in escalasCache) {
            let nomesNoDepto = [];

            for (let mes in escalasCache[depto]) {
                // Filtramos TODOS os nomes daquele depto naquela data (usando .filter em vez de .find)
                const itensEncontrados = (escalasCache[depto][mes].corpo || []).filter(i => i.data === dataRef);
                
                itensEncontrados.forEach(item => {
                    const conflitos = mapaConflitos[item.nome] || [];
                    const temConflito = conflitos.length > 1;
                    
                    // Criamos o HTML do nome com o alerta se houver conflito
                    const htmlNome = `
                        <span class="pessoa-txt" onclick="abrirPopup('${item.nome}', '${dataRef}', '${conflitos.join(',')}')">
                            ${temConflito ? '‚ö†Ô∏è ' : ''}${item.nome}
                        </span>`;
                    nomesNoDepto.push(htmlNome);
                });
            }

            // Se houver algu√©m escalado nesse departamento, adiciona na lista
            if (nomesNoDepto.length > 0) {
                lista.innerHTML += `
                    <div class="linha-escala">
                        <span class="depto-txt">${depto}:</span>
                        <div style="text-align: right; display: flex; flex-direction: column; gap: 4px;">
                            ${nomesNoDepto.join("")}
                        </div>
                    </div>`;
            }
        }

        if (lista.innerHTML === "") {
            lista.innerHTML = "<p style='font-size:0.8rem; color:#94a3b8; text-align:center;'>Nenhuma escala programada para hoje.</p>";
        }
    }

    function realizarBusca() {
    const nomeFiltro = document.getElementById('filtroNome').value.toLowerCase().trim();
    const dataInput = document.getElementById('filtroData').value;
    const resultDiv = document.getElementById('resultadosBusca');
    
    resultDiv.innerHTML = "";

    if (!nomeFiltro && !dataInput) return;

    if (dataInput) {
        // Se tem DATA, vamos renderizar a equipe do dia, 
        // mas passaremos o nomeFiltro para filtrar l√° dentro se necess√°rio.
        const dataBR = dataInput.split('-').reverse().join('/');
        renderizarEquipeData(dataBR, nomeFiltro);
    } else if (nomeFiltro) {
        // Se s√≥ tem NOME, busca o hist√≥rico geral
        resultDiv.innerHTML = `<h4 style="font-size:0.8rem; color:#64748b; margin:20px 0 10px; text-transform:uppercase;">Hist√≥rico de "${nomeFiltro}":</h4>`;
        buscarHistoricoNome(nomeFiltro);
    }
}

    function abrirPopup(nome, data, deptosStr) {
        const lista = deptosStr.split(',');
        document.getElementById('mNome').innerText = nome;
        document.getElementById('mData').innerText = data;
        document.getElementById('mDeptos').innerHTML = lista.map(d => `<p style="margin:8px 0; color:var(--iasd-blue); font-weight:600;">üìç ${d}</p>`).join('');
        
        const iconDiv = document.getElementById('modalIcon');
        iconDiv.innerHTML = lista.length > 1 ? '<div class="alerta-circle">‚ö†Ô∏è</div>' : '';
        
        document.getElementById('modalDetalhes').style.display = 'flex';
    }

    function renderizarEquipeData(dataRef, nomeFiltro = "") {
    const resultDiv = document.getElementById('resultadosBusca');
    let mapaDia = {}; 
    let deptoEquipe = {}; 

    // T√≠tulo da busca
    let titulo = `Equipe de ${dataRef}`;
    if (nomeFiltro) titulo += ` (Filtrando por: ${nomeFiltro})`;
    resultDiv.innerHTML = `<h4 style="font-size:0.8rem; color:#64748b; margin:20px 0 10px; text-transform:uppercase;">${titulo}:</h4>`;

    // 1. Mapear dados
    for (let depto in escalasCache) {
        for (let mes in escalasCache[depto]) {
            const itensEncontrados = (escalasCache[depto][mes].corpo || []).filter(i => i.data === dataRef);
            
            itensEncontrados.forEach(item => {
                // Se o usu√°rio digitou um nome, s√≥ adicionamos se o nome bater com o filtro
                if (nomeFiltro && !item.nome.toLowerCase().includes(nomeFiltro)) return;

                if (!deptoEquipe[depto]) deptoEquipe[depto] = [];
                deptoEquipe[depto].push(item.nome);

                if (!mapaDia[item.nome]) mapaDia[item.nome] = [];
                mapaDia[item.nome].push(depto);
            });
        }
    }

    // 2. Renderizar os resultados
    for (let depto in deptoEquipe) {
        deptoEquipe[depto].forEach(voluntario => {
            const deptosOndeEsta = mapaDia[voluntario];
            const temConflito = deptosOndeEsta.length > 1;
            
            resultDiv.innerHTML += `
                <div class="result-item" onclick="abrirPopup('${voluntario}', '${dataRef}', '${deptosOndeEsta.join(',')}')" style="cursor:pointer;">
                    <div class="nome-click">
                        <span class="depto-tag" style="margin-left:0; margin-right:10px;">${temConflito ? '‚ö†Ô∏è' : 'üìç'}</span>
                        <strong>${voluntario}</strong>
                    </div>
                    <span class="btn-ver" style="text-align:right; font-size:0.75rem;">
                        ${depto.toUpperCase()}
                    </span>
                </div>`;
        });
    }
    
    if (Object.keys(deptoEquipe).length === 0) {
        resultDiv.innerHTML += "<p style='font-size:0.8rem; color:#94a3b8;'>Nenhum resultado encontrado para esta combina√ß√£o.</p>";
    }
}

    function buscarHistoricoNome(nome) {
    const resultDiv = document.getElementById('resultadosBusca');
    let todasAsEscalas = [];

    // 1. Coleta todos os registros onde o nome aparece
    for (let depto in escalasCache) {
        for (let mes in escalasCache[depto]) {
            (escalasCache[depto][mes].corpo || []).forEach(item => {
                if (item.nome.toLowerCase().includes(nome)) {
                    todasAsEscalas.push({
                        data: item.data, // formato DD/MM/AAAA
                        depto: depto,
                        nomeOriginal: item.nome
                    });
                }
            });
        }
    }

    // 2. L√≥gica de ordena√ß√£o (Transforma a data em algo compar√°vel pelo JS)
    todasAsEscalas.sort((a, b) => {
        const dataA = a.data.split('/').reverse().join(''); // Vira AAAAMMDD
        const dataB = b.data.split('/').reverse().join('');
        return dataA.localeCompare(dataB);
    });

    // 3. Renderiza os resultados j√° ordenados
    if (todasAsEscalas.length > 0) {
        todasAsEscalas.forEach(item => {
            const dataCurta = item.data.substring(0, 5); // Exibe apenas DD/MM
            
            // Aqui buscamos todos os deptos desse volunt√°rio nessa data espec√≠fica para o popup de conflito
            let deptosNoDia = [];
            for (let d in escalasCache) {
                for (let m in escalasCache[d]) {
                    if ((escalasCache[d][m].corpo || []).some(i => i.data === item.data && i.nome === item.nomeOriginal)) {
                        deptosNoDia.push(d);
                    }
                }
            }

            const temConflito = deptosNoDia.length > 1;

            resultDiv.innerHTML += `
                <div class="result-item" onclick="abrirPopup('${item.nomeOriginal}', '${item.data}', '${deptosNoDia.join(',')}')" style="cursor:pointer;">
                    <div>
                        <span class="data-tag">${dataCurta}</span>
                        <span class="depto-tag">${temConflito ? '‚ö†Ô∏è ' : ''}${item.depto}</span>
                    </div>
                    <span class="btn-ver">VER DETALHES</span>
                </div>`;
        });
    } else {
        resultDiv.innerHTML = "<p style='font-size:0.8rem; color:#94a3b8;'>Nenhum registro encontrado.</p>";
    }
}

    window.onload = iniciar;
</script>
</body>
</html>
