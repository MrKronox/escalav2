<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Escalas - IASD</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    
    
    <link rel="manifest" href="manifest.json">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icone-app.png">

    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('Service Worker registrado com sucesso!'))
            .catch(err => console.error('Falha ao registrar Service Worker:', err));
        });
    }
    </script>
    
    
    
    <style>
        :root { 
            --iasd-blue: #003366; 
            --iasd-gold: #c5a059; 
            --bg: #f8fafc; 
            --danger: #ef4444;
            --text-main: #1e293b;
        }

        body { font-family: 'Inter', 'Segoe UI', sans-serif; background: var(--bg); margin: 0; color: var(--text-main); }
        
        header { 
            background: var(--iasd-blue); color: white; padding: 30px 15px; text-align: center;
            border-bottom: 6px solid var(--iasd-gold); box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .container { padding: 20px; max-width: 480px; margin: auto; }

        /* Card Pr√≥ximo Culto - Layout id√™ntico ao index */
        .card-proximo {
            background: white; border-radius: 20px; padding: 25px;
            box-shadow: 0 10px 30px rgba(0,51,102,0.05); margin-bottom: 30px;
            border-left: 6px solid var(--iasd-gold);
        }
        .card-proximo h2 { 
            color: var(--iasd-blue); font-size: 0.85rem; margin: 0 0 20px; 
            text-transform: uppercase; letter-spacing: 1.5px; border-bottom: 1px solid #f1f5f9;
            padding-bottom: 12px; font-weight: 800;
        }

        .linha-escala {
            display: flex; justify-content: space-between; align-items: center;
            padding: 14px 0; border-bottom: 1px dashed #e2e8f0;
        }
        .linha-escala:last-child { border-bottom: none; }
        .depto-txt { font-weight: 500; color: #64748b; font-size: 0.9rem; }
        .pessoa-txt { font-weight: 700; color: var(--iasd-blue); font-size: 1rem; cursor: pointer; }

        /* Bal√µes de Pesquisa Modernos */
        .search-container {
            background: white; padding: 25px; border-radius: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); margin-bottom: 20px;
            border: 1px solid #f1f5f9;
        }
        .search-group { margin-bottom: 18px; position: relative; }
        .search-group label { 
            display: block; font-size: 0.75rem; font-weight: 700; color: var(--iasd-blue);
            margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;
        }
        .search-group input { 
            width: 100%; padding: 14px 18px; border: 2px solid #f1f5f9; border-radius: 14px;
            box-sizing: border-box; font-size: 1rem; transition: 0.3s; background: #f8fafc;
        }
        .search-group input:focus { border-color: var(--iasd-gold); outline: none; background: white; }

        /* Resultados da busca refinados */
        .result-item {
            background: white; margin-bottom: 8px; padding: 15px 20px; border-radius: 16px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.02); border: 1px solid #f1f5f9;
        }
        .data-tag { font-weight: 800; color: #64748b; font-size: 0.85rem; }
        .depto-tag { font-weight: 600; color: var(--iasd-blue); margin-left: 8px; }
        .btn-ver { color: var(--iasd-gold); font-weight: 800; font-size: 0.8rem; text-transform: uppercase; cursor: pointer; }

        /* Modal Estilizado */
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(15, 23, 42, 0.9); z-index: 1000; align-items: center; justify-content: center; 
            backdrop-filter: blur(8px);
        }
        .modal-content { 
            background: white; padding: 35px; border-radius: 28px; width: 85%; max-width: 320px; 
            text-align: center; border-top: 8px solid var(--iasd-gold);
        }
        .alerta-circle { 
            width: 60px; height: 60px; background: #fee2e2; color: var(--danger);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            margin: 0 auto 15px; font-size: 1.5rem;
        }
    </style>
</head>
<body>

<header>
    <p style="font-size: 0.65rem; letter-spacing: 4px; opacity: 0.8; margin: 0;">IGREJA ADVENTISTA</p>
    <h1 style="margin: 8px 0 0; font-size: 1.4rem; letter-spacing: 1px;">PORTAL DE ESCALAS</h1>
</header>

<div class="container">
    <div class="card-proximo">
        <h2 id="tituloCard">Pr√≥ximo Culto</h2>
        <div id="listaProximo">Carregando informa√ß√µes...</div>
    </div>

    <div class="search-container">
        <div class="search-group">
            <label>üîé Buscar Volunt√°rio</label>
            <input type="text" id="filtroNome" placeholder="Digite um nome..." oninput="realizarBusca()">
        </div>
        <div class="search-group" style="margin-bottom: 0;">
            <label>üìÖ Filtrar por Data</label>
            <input type="date" id="filtroData" onchange="realizarBusca()">
        </div>
    </div>

    <div id="resultadosBusca"></div>
</div>

<div id="modalDetalhes" class="modal" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div id="modalIcon"></div>
        <h3 id="mNome" style="margin: 0; color: var(--iasd-blue); font-size: 1.3rem;"></h3>
        <p id="mData" style="color: #64748b; font-weight: 600; margin: 5px 0 20px;"></p>
        <div id="mDeptos" style="text-align: left; background: #f8fafc; padding: 15px; border-radius: 12px;"></div>
        <button onclick="document.getElementById('modalDetalhes').style.display='none'" 
                style="margin-top: 25px; width: 100%; padding: 15px; border: none; background: var(--iasd-blue); color: white; border-radius: 12px; font-weight: 700; cursor: pointer;">
            FECHAR
        </button>
    </div>
</div>

<script>
    // Configura√ß√£o do Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyBYtUnqsokLE1RnK1TGbswbnsLXPpvvdc0",
        authDomain: "escala7igreja.firebaseapp.com",
        databaseURL: "https://escala7igreja-default-rtdb.firebaseio.com",
        projectId: "escala7igreja",
        storageBucket: "escala7igreja.firebasestorage.app",
        messagingSenderId: "778312493987",
        appId: "1:778312493987:web:2851b2fc65331e4ac14816"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let escalasCache = {};

    async function iniciar() {
        const snap = await db.ref("escalas_salvas").once('value');
        escalasCache = snap.val() || {};
        definirProximoCulto();
    }

    function definirProximoCulto() {
        const agora = new Date();
        const diasCulto = [0, 3, 6]; 
        let dataAlvo = new Date(agora);
        
        if (agora.getHours() >= 20) dataAlvo.setDate(dataAlvo.getDate() + 1);
        while (!diasCulto.includes(dataAlvo.getDay())) { dataAlvo.setDate(dataAlvo.getDate() + 1); }

        const nomesDias = ["DOMINGO", "SEGUNDA", "TER√áA", "QUARTA-FEIRA", "QUINTA", "SEXTA", "S√ÅBADO"];
        document.getElementById('tituloCard').innerText = `ESCALA DE ${nomesDias[dataAlvo.getDay()]}`;
        
        const dataStr = dataAlvo.toLocaleDateString('pt-BR');
        renderizarCardHoje(dataStr);
    }

    function renderizarCardHoje(dataRef) {
        const lista = document.getElementById('listaProximo');
        lista.innerHTML = "";
        
        let mapa = {};
        for (let depto in escalasCache) {
            for (let mes in escalasCache[depto]) {
                const item = (escalasCache[depto][mes].corpo || []).find(i => i.data === dataRef);
                if (item) {
                    if (!mapa[item.nome]) mapa[item.nome] = [];
                    mapa[item.nome].push(depto);
                    
                    // Invertido: Depto Esquerda, Nome Direita
                    lista.innerHTML += `
                        <div class="linha-escala">
                            <span class="depto-txt">${depto}:</span>
                            <span class="pessoa-txt" onclick="abrirPopup('${item.nome}', '${dataRef}', '${mapa[item.nome].join(',')}')">
                                ${mapa[item.nome].length > 1 ? '‚ö†Ô∏è ' : ''}${item.nome}
                            </span>
                        </div>`;
                }
            }
        }
    }

    function realizarBusca() {
        const nome = document.getElementById('filtroNome').value.toLowerCase().trim();
        const dataInput = document.getElementById('filtroData').value;
        const resultDiv = document.getElementById('resultadosBusca');
        
        // Limpa os resultados anteriores antes de uma nova busca
        resultDiv.innerHTML = "";

        if (!nome && !dataInput) return;

        if (dataInput) {
            // PESQUISA POR DATA: Mostra a equipe completa do dia selecionado
            const dataBR = dataInput.split('-').reverse().join('/');
            resultDiv.innerHTML = `<h4 style="font-size:0.8rem; color:#64748b; margin:20px 0 10px; text-transform:uppercase;">Equipe de ${dataBR}:</h4>`;
            renderizarEquipeData(dataBR);
        } else if (nome) {
            // PESQUISA POR NOME: Mostra o hist√≥rico do volunt√°rio
            resultDiv.innerHTML = `<h4 style="font-size:0.8rem; color:#64748b; margin:20px 0 10px; text-transform:uppercase;">Escalas de "${nome}":</h4>`;
            buscarHistoricoNome(nome);
        }
    }

    function abrirPopup(nome, data, deptosStr) {
        const lista = deptosStr.split(',');
        document.getElementById('mNome').innerText = nome;
        document.getElementById('mData').innerText = data;
        document.getElementById('mDeptos').innerHTML = lista.map(d => `<p style="margin:8px 0; color:var(--iasd-blue); font-weight:600;">üìç ${d}</p>`).join('');
        
        const iconDiv = document.getElementById('modalIcon');
        iconDiv.innerHTML = lista.length > 1 ? '<div class="alerta-circle">‚ö†Ô∏è</div>' : '';
        
        document.getElementById('modalDetalhes').style.display = 'flex';
    }

    function renderizarEquipeData(dataRef) {
        const resultDiv = document.getElementById('resultadosBusca');
        let mapaDia = {};

        // Agrupa todos os departamentos para aquela data espec√≠fica
        for (let depto in escalasCache) {
            for (let mes in escalasCache[depto]) {
                const item = (escalasCache[depto][mes].corpo || []).find(i => i.data === dataRef);
                if (item) {
                    if (!mapaDia[item.nome]) mapaDia[item.nome] = [];
                    mapaDia[item.nome].push(depto);
                }
            }
        }

        // Renderiza cada pessoa encontrada na parte de baixo
        for (let voluntario in mapaDia) {
            const deptos = mapaDia[voluntario];
            const temConflito = deptos.length > 1;
            
            resultDiv.innerHTML += `
                <div class="result-item">
                    <div class="nome-click" onclick="abrirPopup('${voluntario}', '${dataRef}', '${deptos.join(',')}')">
                        <span class="depto-tag" style="margin-left:0; margin-right:10px;">${temConflito ? '‚ö†Ô∏è' : 'üìç'}</span>
                        <strong>${voluntario}</strong>
                    </div>
                    <span class="btn-ver" onclick="abrirPopup('${voluntario}', '${dataRef}', '${deptos.join(',')}')">
                        ${temConflito ? 'VER CONFLITO' : deptos[0]}
                    </span>
                </div>`;
        }
        
        if (Object.keys(mapaDia).length === 0) {
            resultDiv.innerHTML += "<p style='font-size:0.8rem; color:#94a3b8;'>Nenhuma escala para esta data.</p>";
        }
    }

    function buscarHistoricoNome(nome) {
        const resultDiv = document.getElementById('resultadosBusca');
        let encontrou = false;

        for (let depto in escalasCache) {
            for (let mes in escalasCache[depto]) {
                (escalasCache[depto][mes].corpo || []).forEach(item => {
                    if (item.nome.toLowerCase().includes(nome)) {
                        encontrou = true;
                        // Exibe a data curta (DD/MM) conforme solicitado
                        const dataCurta = item.data.substring(0, 5);
                        resultDiv.innerHTML += `
                            <div class="result-item">
                                <div>
                                    <span class="data-tag">${dataCurta}</span>
                                    <span class="depto-tag">${depto}</span>
                                </div>
                                <span class="btn-ver" onclick="abrirPopup('${item.nome}', '${item.data}', '${depto}')">Ver Detalhes</span>
                            </div>`;
                    }
                });
            }
        }
        if (!encontrou) resultDiv.innerHTML = "<p style='font-size:0.8rem; color:#94a3b8;'>Nenhum registro encontrado.</p>";
    }

    window.onload = iniciar;
</script>
</body>
</html>
