<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gest√£o de Equipe - IASD</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --iasd-blue: #003366; --iasd-light: #f4f7f9; --success: #22c55e; --danger: #dc2626; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--iasd-light); margin: 0; padding-bottom: 50px; }
        header { 
            background: #003366; /* Azul IASD */
            color: white; 
            padding: 25px 15px; 
            text-align: center;
            border-bottom: 5px solid #c5a059; /* Linha Dourada */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px; 
        }
        header h1 { margin: 0; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; }
        header p { margin: 5px 0 0; font-size: 0.7rem; letter-spacing: 3px; opacity: 0.9; }

        .container { padding: 15px; max-width: 600px; margin: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h3 { color: var(--iasd-blue); margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        label { display: block; font-weight: bold; margin: 15px 0 5px; color: #555; font-size: 0.9rem; }
        input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        /* Container para alinhar Input e Bot√£o "Add Item" */
        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .input-row input {
            flex: 1; /* Ocupa o espa√ßo m√°ximo */
        }
        .dias-grid { display: flex; justify-content: space-between; gap: 5px; margin-top: 10px; }
        .dia-btn { flex: 1; height: 35px; border-radius: 6px; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: bold; background: white; font-size: 11px; }
        .dia-btn.active { background: var(--success); color: white; border-color: var(--success); }
        .btn-main { width: 100%; padding: 15px; background: var(--iasd-blue); color: white; border: none; border-radius: 8px; font-weight: bold; margin-top: 20px; font-size: 1rem; cursor: pointer; }
        .btn-del { color: var(--danger); background: none; border: none; font-size: 1.2rem; cursor: pointer; }
        .back-link { display: inline-block; margin-bottom: 15px; text-decoration: none; color: var(--iasd-blue); font-weight: bold; }
        /* O bot√£o de adicionar compacto (Baseado no seu modelo) */
        .button-add-compact {
            position: relative;
            width: 45px; /* Come√ßa pequeno apenas com o √≠cone */
            height: 45px;
            cursor: pointer;
            display: flex;
            align-items: center;
            border: 1px solid #34974d;
            background-color: #3aa856;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s;
            flex-shrink: 0;
        }
        .button-add-compact .button__text {
            opacity: 0;
            color: #fff;
            font-weight: 600;
            font-size: 0.8rem;
            white-space: nowrap;
            transition: all 0.3s;
            position: absolute;
            left: 45px;
        }
        .button-add-compact .button__icon {
            position: absolute;
            height: 100%;
            width: 45px;
            background-color: #34974d;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            left: 0;
        }

    .button-add-compact svg { width: 24px; stroke: #fff; }

    /* Efeito Hover: Expande para mostrar o texto */
    .button-add-compact:hover { width: 90px; }
    .button-add-compact:hover .button__text { opacity: 1; transform: translateX(-5px); padding: 9px; }
    .button-add-compact:hover .button__icon { background-color: #2e8644; }

    /* Ajuste de cor para o bot√£o de Gerar Escala no final */
    .btn-gold-main {
        background-color: #c5a059 !important;
        color: #f3f3f3 !important;
        box-shadow: 0 4px 12px rgba(197, 160, 89, 0.3);
        border-radius: 12px !important;
    }

    /* Bot√£o Voltar Estilizado */
    .btn-voltar-container {
        margin-bottom: 20px;
        display: inline-block;
    }

    .button-back {
        background-color: transparent;
        color: var(--iasd-blue);
        width: 8.5em;
        height: 2.9em;
        border: var(--iasd-blue) 0.15em solid; /* Borda um pouco mais fina para eleg√¢ncia */
        border-radius: 11px;
        text-align: right;
        transition: all 0.5s ease;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        cursor: pointer;
        font-weight: 600;
        padding: 0;
    }

    .button-back:hover {
        background-color: var(--iasd-blue);
        color: #fff;
    }

    .button-back svg {
        width: 1.4em;
        left: 0.8em;
        position: absolute;
        transition: all 0.5s ease;
        /* Invertendo a seta para apontar para a esquerda */
        transform: rotate(180deg); 
    }

    .button-back:hover svg {
        transform: rotate(180deg) translateX(5px);
        stroke: #fff;
    }

    .button-back .text {
        margin: 0 1.2em;
    }
    </style>
</head>
<body>

<header>
    <p>IGREJA ADVENTISTA DO S√âTIMO DIA</p>
    <h1 id="headerTitle">SISTEMA DE GEST√ÉO DE ESCALAS</h1>
</header>

<div class="container">
    <div class="btn-voltar-container">
        <button class="button-back" onclick="window.location.href='index.html'">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12h15m0 0l-6.75-6.75M19.5 12l-6.75 6.75" />
            </svg>
            <div class="text">Voltar</div>
        </button>
    </div>

    <div class="card">
        <h3>Adicionar ao Departamento</h3>
        
        <label>Nome do Volunt√°rio:</label>
        <div class="input-row">
            <input type="text" id="buscaMembro" list="membrosData" placeholder="Digite o nome...">
            <datalist id="membrosData"></datalist>

            <button type="button" class="button-add-compact" onclick="vincularAoDepartamento()">
                <span class="button__text">+Add</span>
                <span class="button__icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" stroke-width="2" stroke-linejoin="round" stroke-linecap="round" stroke="currentColor" fill="none">
                        <line y2="19" y1="5" x2="12" x1="12" /><line y2="12" y1="12" x2="19" x1="5" />
                    </svg>
                </span>
            </button>
        </div>

        <label>Departamento Selecionado:</label>
        <div id="displayDepto" style="font-weight: bold; color: var(--iasd-blue); padding: 12px; background: #eef2f7; border-radius: 8px; margin-bottom: 10px;"></div>

        <button onclick="irParaGerador()" class="btn-main btn-gold-main">
            üöÄ Gerar Escala de <span id="nomeDeptoBotao"></span>
        </button>
    </div>
    
    <div class="card">
        <h3>Equipe Escal√°vel</h3>
        <div id="listaVinculados">Carregando membros...</div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyBYtUnqsokLE1RnK1TGbswbnsLXPpvvdc0",
        authDomain: "escala7igreja.firebaseapp.com",
        databaseURL: "https://escala7igreja-default-rtdb.firebaseio.com",
        projectId: "escala7igreja",
        storageBucket: "escala7igreja.firebasestorage.app",
        messagingSenderId: "778312493987",
        appId: "1:778312493987:web:2851b2fc65331e4ac14816"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const urlParams = new URLSearchParams(window.location.search);
    const deptoLogado = urlParams.get('depto'); 

    if (!deptoLogado) { window.location.href = "index.html"; }

    let membrosBaseGeral = {};

    function carregarMembrosFirebase() {
        db.ref('membros').on('value', (snapshot) => {
            const datalist = document.getElementById('membrosData');
            datalist.innerHTML = "";
            membrosBaseGeral = snapshot.val() || {};
            
            for (let id in membrosBaseGeral) {
                const m = membrosBaseGeral[id];
                let opt = document.createElement('option');
                
                // Aqui voltamos a exibir o Nome de Exibi√ß√£o para facilitar a pesquisa
                const labelExibicao = m.nomeExibicao ? ` (${m.nomeExibicao})` : "";
                opt.value = m.nomeCompleto; // O valor enviado ainda √© o nome completo
                opt.label = labelExibicao;   // O navegador mostra o r√≥tulo ao lado
                
                datalist.appendChild(opt);
            }
        });
    }

    function vincularAoDepartamento() {
        const nomeDigitado = document.getElementById('buscaMembro').value.trim();
        let idOriginal = null;
        let infoMembro = null;

        // Procura na base o objeto que corresponde ao nome completo digitado
        for (let id in membrosBaseGeral) {
            if (membrosBaseGeral[id].nomeCompleto === nomeDigitado) {
                idOriginal = id;
                infoMembro = membrosBaseGeral[id];
                break;
            }
        }

        if (!idOriginal) {
            alert("‚ö†Ô∏è Selecione um nome v√°lido da lista de sugest√µes!");
            return;
        }

        const novoVinculo = {
            membroId: idOriginal,
            nomeCompleto: infoMembro.nomeCompleto,
            nomeExibicao: infoMembro.nomeExibicao || infoMembro.nomeCompleto,
            departamento: deptoLogado,
            disponibilidade: ["0", "1", "2", "3", "4", "5", "6"]
        };

        db.ref('equipes_deptos').push(novoVinculo).then(() => {
            document.getElementById('buscaMembro').value = "";
            alert(`‚úÖ ${infoMembro.nomeExibicao || infoMembro.nomeCompleto} vinculado ao ${deptoLogado}!`);
        });
    }

    function listarEquipes() {
        db.ref('equipes_deptos').orderByChild('departamento').equalTo(deptoLogado).on('value', (snapshot) => {
            const div = document.getElementById('listaVinculados');
            div.innerHTML = "";
            
            if (!snapshot.exists()) {
                div.innerHTML = `<p style="text-align:center; color:#999;">Nenhum membro vinculado a ${deptoLogado}.</p>`;
                return;
            }

            snapshot.forEach(item => {
                const d = item.val();
                const chave = item.key;
                const dias = d.disponibilidade || [];
                const nomesDias = ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'];
                
                let botoesHtml = '';
                nomesDias.forEach((n, i) => {
                    const ativo = dias.includes(i.toString()) ? 'active' : '';
                    botoesHtml += `<div class="dia-btn ${ativo}" onclick="alternarDia('${chave}', '${i}')">${n}</div>`;
                });

                div.innerHTML += `
                    <div class="card" style="padding:12px; margin-bottom:10px; border-left: 5px solid var(--iasd-blue);">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <strong>${d.nomeExibicao || d.nomeCompleto}</strong>
                            <button class="btn-del" onclick="remover('${chave}')">üóëÔ∏è</button>
                        </div>
                        <div class="dias-grid">${botoesHtml}</div>
                    </div>`;
            });
        });
    }

    function alternarDia(chave, dia) {
        const ref = db.ref('equipes_deptos').child(chave);
        ref.once('value').then(snap => {
            let dias = snap.val().disponibilidade || [];
            dias = dias.includes(dia) ? dias.filter(d => d !== dia) : [...dias, dia];
            ref.update({ disponibilidade: dias });
        });
    }

    function remover(id) {
        if (confirm("Remover membro deste departamento?")) db.ref('equipes_deptos').child(id).remove();
    }

    function irParaGerador() {
        if (!deptoLogado) return alert("Erro: Departamento n√£o identificado.");
        window.location.href = `gerador.html?depto=${encodeURIComponent(deptoLogado)}`;
    }

    window.onload = () => {
        document.getElementById('headerTitle').innerText = `‚õ™ Gest√£o: ${deptoLogado}`;
        document.getElementById('displayDepto').innerText = deptoLogado;
        
        // ATUALIZA√á√ÉO: Altera o texto do bot√£o dourado para o nome do depto
        const btnTexto = document.getElementById('nomeDeptoBotao');
        if (btnTexto) btnTexto.innerText = deptoLogado;

        carregarMembrosFirebase();
        listarEquipes();
    };
</script>
</body>
</html>
